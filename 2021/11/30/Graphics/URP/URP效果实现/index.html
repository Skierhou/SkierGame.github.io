<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>URP效果实现,从基础慢慢深入 | Skier</title><meta name="keywords" content="Graphics,URP"><meta name="author" content="Skier"><meta name="copyright" content="Skier"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="URP效果实现">
<meta property="og:type" content="article">
<meta property="og:title" content="URP效果实现,从基础慢慢深入">
<meta property="og:url" content="https://skierhou.github.io/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="Skier">
<meta property="og:description" content="URP效果实现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://skierhou.github.io/img/1.png">
<meta property="article:published_time" content="2021-11-30T06:30:01.000Z">
<meta property="article:modified_time" content="2021-12-21T12:18:20.166Z">
<meta property="article:author" content="Skier">
<meta property="article:tag" content="Graphics">
<meta property="article:tag" content="URP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://skierhou.github.io/img/1.png"><link rel="shortcut icon" href="/blog/img/head.jpg"><link rel="canonical" href="https://skierhou.github.io/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Skier","link":"链接: ","source":"来源: Skier","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2021-12-21 20:18:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/blog/atom.xml" title="Skier" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/blog/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清單</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/blog/%E9%9F%B3%E6%A8%82"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page" href="/blog/%E7%85%A7%E7%89%87"><i class="fa-fw /Gallery/"></i><span> 1</span></a></li><li><a class="site-page" href="/blog/%E9%9B%BB%E5%BD%B1"><i class="fa-fw /movies/"></i><span> 2</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/blog/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/blog/about/"><i class="fa-fw fas fa-heart"></i><span> 關於</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/blog/img/1.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog/">Skier</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清單</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/blog/%E9%9F%B3%E6%A8%82"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page" href="/blog/%E7%85%A7%E7%89%87"><i class="fa-fw /Gallery/"></i><span> 1</span></a></li><li><a class="site-page" href="/blog/%E9%9B%BB%E5%BD%B1"><i class="fa-fw /movies/"></i><span> 2</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/blog/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/blog/about/"><i class="fa-fw fas fa-heart"></i><span> 關於</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">URP效果实现,从基础慢慢深入</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-30T06:30:01.000Z" title="发表于 2021-11-30 14:30:01">2021-11-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-21T12:18:20.166Z" title="更新于 2021-12-21 20:18:20">2021-12-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/Unity/">Unity</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>100分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="URP效果实现,从基础慢慢深入"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>之前学习过入门精要，之后就很少接触了，现在接触URP，再学习一遍入门精要也顺便学习下HLSL，<br>主要是对着链接中的<a target="_blank" rel="noopener" href="https://space.bilibili.com/5863867/article">URP HLSL入门学习</a>进行学习，会有一定自己的扩展</p>
<h1 id="基础光照模型"><a href="#基础光照模型" class="headerlink" title="基础光照模型"></a>基础光照模型</h1><h2 id="基础公式"><a href="#基础公式" class="headerlink" title="基础公式"></a>基础公式</h2><ul>
<li>Lambert：     max(0,dot(L,N))</li>
<li>HalfLambert： max(0,dot(L,N)) * 0.5 + 0.5</li>
<li>Phong：       pow(max(0,dot(reflect(-L,N), V)), Gloss)</li>
<li>BlinnPhong：  pow(max(0,dot(normalize(L+V), N)), Gloss)</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><ul>
<li><p>Lambert / HalfLambert</p>
<figure class="highlight plain"><figcaption><span>/ HalfLambert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Lambert&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _BaseColor (&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 normalWS:TEXCOORD1; </span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.normalWS &#x3D; TransformObjectToWorldNormal(i.normalOS.xyz, true); </span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            Light mylight &#x3D; GetMainLight(); </span><br><span class="line">            real4 LightColor &#x3D; real4(mylight.color, 1); </span><br><span class="line">            float3 lightDir &#x3D; normalize(mylight.direction);</span><br><span class="line">            float lambert &#x3D; dot(normalize(i.normalWS), lightDir);</span><br><span class="line">            float halfLambert &#x3D; lambert * 0.5f + 0.5f;</span><br><span class="line"></span><br><span class="line">            float4 color &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">            return color * _BaseColor * halfLambert * LightColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Phong / BlinnPhong</p>
<figure class="highlight plain"><figcaption><span>/ BlinnPhong</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Phong&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex(&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _GlossColor(&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Gloss(&quot;Gloss&quot;, Range(1, 256)) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _GlossColor;</span><br><span class="line">        float _Gloss;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 normalWS:TEXCOORD1;</span><br><span class="line">            float3 viewDirWS:TEXCOORD2;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.viewDirWS &#x3D; normalize(_WorldSpaceCameraPos.xyz - TransformObjectToWorld(i.positionOS.xyz));&#x2F;&#x2F;得到世界空间的视图方向 </span><br><span class="line">            o.normalWS &#x3D; TransformObjectToWorldNormal(i.normalOS.xyz, true);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            Light mylight &#x3D; GetMainLight();</span><br><span class="line">            real4 LightColor &#x3D; real4(mylight.color, 1);</span><br><span class="line">            float3 lightDir &#x3D; normalize(mylight.direction);</span><br><span class="line">            float3 viewDir &#x3D; normalize(i.viewDirWS);</span><br><span class="line">            float3 worldNormal &#x3D; normalize(i.normalWS);</span><br><span class="line">            float phong &#x3D; pow(max(dot(reflect(-lightDir, worldNormal), viewDir), 0), _Gloss);</span><br><span class="line">            float blinnPhong &#x3D; pow(max(dot(normalize(lightDir + viewDir), worldNormal), 0), _Gloss);</span><br><span class="line"></span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">            float4 diffuse &#x3D; LightColor * col * max(dot(lightDir, worldNormal), 0);</span><br><span class="line">            float4 specular &#x3D; _GlossColor * blinnPhong * LightColor;</span><br><span class="line">            return float4(specular.rgb + diffuse.rgb, col.a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>TransformObjectToHClip</li>
<li>TransformObjectToWorld</li>
<li>TransformObjectToWorldNormal</li>
<li>_WorldSpaceCameraPos</li>
<li>光照信息： #include “Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl”</li>
<li>SubShader{HLSLINCLUDE … ENDHLSL}  Pass{HLSLPROGRAM … ENDHLSL}   (第一次写Pass中写成HLSLEINCLUDE了，没报错效果又一直是错的，注意了！！！)</li>
</ul>
<h1 id="法线贴图"><a href="#法线贴图" class="headerlink" title="法线贴图"></a>法线贴图</h1><h2 id="基础简介"><a href="#基础简介" class="headerlink" title="基础简介"></a>基础简介</h2><ol>
<li><p>我们采用在世界坐标系下，在片元着色器中进行计算。<br>定义顶点着色器拿到数据的结构体，我们需要顶点位置，uv，顶点法线，顶点切线</p>
</li>
<li><p>获得世界坐标系下的：顶点位置，法线，切线，副切线<br>计算副切线时，叉乘法线，切线，并在乘切线的w值判断正负，在乘负奇数缩放影响因子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o.BtangentWS&#x3D; cross(o.normal.xyz,o.tangent.xyz) * i.tangent.w;</span><br></pre></td></tr></table></figure>
</li>
<li><p>片元处理中采样法线贴图，得切线空间法线，在将其转换到世界空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float3x3 T2W &#x3D; &#123;i.tangentWS.xyz,i.BtangentWS.xyz,i.normalWS.xyz&#125;; </span><br><span class="line">float4 norTex &#x3D; SAMPLE_TEXTURE2D(_NormalTex, sampler_NormalTex, i.uv);</span><br><span class="line">float3 nomralTS &#x3D; UnpackNormalScale(norTex, _NormalScale);</span><br><span class="line">normalTS.z&#x3D;pow((1-pow(normalTS.x,2)-pow(normalTS.y,2)),0.5); &#x2F;&#x2F;规范化法线 不影响x,y情况下规范化z轴</span><br><span class="line">float3 normalWS &#x3D; normalize(mul(normalTS,T2W));</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用带入法线贴图计算后的法线用于后续计算即可。</p>
</li>
</ol>
<h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Normal&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        [Normal]_NormalTex(&quot;NormalTex&quot;, 2D) &#x3D; &quot;bump&quot;&#123;&#125;</span><br><span class="line">        _NormalScale(&quot;NormalScale&quot;, float) &#x3D; 1</span><br><span class="line">        [HDR]_SpecularColor(&quot;SpecularColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Gloss(&quot;Gloss&quot;,Range(1,256)) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_NormalTex);</span><br><span class="line">        SAMPLER(sampler_NormalTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _NormalTex_ST;</span><br><span class="line">        float _NormalScale;</span><br><span class="line">        float4 _SpecularColor;</span><br><span class="line">        float _Gloss;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float4 tangentOS:TANGENT;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float4 uv            : TEXCOORD0;</span><br><span class="line">            float4 normalWS:TEXCOORD1;</span><br><span class="line">            float4 tangentWS:TEXCOORD2;</span><br><span class="line">            float4 BtangentWS:TEXCOORD3;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS);</span><br><span class="line">            o.normalWS.xyz &#x3D; normalize(TransformObjectToWorldNormal(i.normalOS));</span><br><span class="line">            o.tangentWS.xyz &#x3D; normalize(TransformObjectToWorld(i.tangentOS));</span><br><span class="line">            o.BtangentWS.xyz &#x3D; cross(o.normalWS.xyz, o.tangentWS.xyz) * i.tangentOS.w * unity_WorldTransformParams.w;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 存一下世界空间坐标</span><br><span class="line">            float3 positionWS &#x3D; TransformObjectToWorld(i.positionOS);</span><br><span class="line">            o.tangentWS.w &#x3D; positionWS.x;</span><br><span class="line">            o.BtangentWS.w &#x3D; positionWS.y;</span><br><span class="line">            o.normalWS.w &#x3D; positionWS.z;</span><br><span class="line"></span><br><span class="line">            o.uv.xy &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.uv.zw &#x3D; TRANSFORM_TEX(i.uv, _NormalTex);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float4 norTex &#x3D; SAMPLE_TEXTURE2D(_NormalTex, sampler_NormalTex, i.uv.zw);</span><br><span class="line">            float3 positionWS &#x3D; float3(i.tangentWS.w, i.BtangentWS.w, i.normalWS.w);</span><br><span class="line">            float3x3 T2W &#x3D; &#123;i.tangentWS.xyz, i.BtangentWS.xyz, i.normalWS.xyz&#125;;</span><br><span class="line"></span><br><span class="line">            float3 normalTS &#x3D; UnpackNormalScale(norTex, _NormalScale);</span><br><span class="line">            normalTS.z &#x3D; pow(1 - pow(normalTS.x, 2) - pow(normalTS.y, 2), 0.5f);    &#x2F;&#x2F;规范化</span><br><span class="line">            float3 normalWS &#x3D; mul(normalTS, T2W);</span><br><span class="line">            float3 viewDirWS &#x3D; normalize(_WorldSpaceCameraPos.xyz - positionWS);</span><br><span class="line">            Light myLight &#x3D; GetMainLight();</span><br><span class="line">            float3 lightDir &#x3D; normalize(myLight.direction);</span><br><span class="line"></span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv.xy);</span><br><span class="line"></span><br><span class="line">            float halfLambert &#x3D; dot(normalWS, lightDir) * 0.5f + 0.5f;</span><br><span class="line">            float3 diffuse &#x3D; myLight.color * col.xyz * halfLambert;</span><br><span class="line">            float3 specular &#x3D; myLight.color * _SpecularColor.rgb * pow(dot(normalize(viewDirWS + lightDir), normalWS), _Gloss);</span><br><span class="line"></span><br><span class="line">            return float4(diffuse + specular, col.a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ul>
<li>规范化向量一般用normalize，在不想影响xy轴情况下可以使用勾股定理自己计算另一个轴的值</li>
<li>UnpackNormal，UnpackNormalScale</li>
<li>mul(), 矩阵相乘</li>
<li>为了节省空间，可以将一些值藏在部分多余参数中，比如这次代码中，将世界空间坐标xyz分别写在切线，副切线，法线的w值上</li>
</ul>
<h1 id="渐变纹理"><a href="#渐变纹理" class="headerlink" title="渐变纹理"></a>渐变纹理</h1><h2 id="基础思路"><a href="#基础思路" class="headerlink" title="基础思路"></a>基础思路</h2><p>不适用常规的模型uv，而是使用lambert/halflambert的值作为x轴或y轴，对渐变纹理图进行采样</p>
<h2 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Ramp&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _RampTex(&quot;RampTex&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_RampTex);</span><br><span class="line">        SAMPLER(sampler_RampTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _RampTex_ST;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 normalWS :TEXCOORD1;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.normalWS &#x3D; normalize(TransformObjectToWorldNormal(i.normalOS));</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line"></span><br><span class="line">            Light light &#x3D; GetMainLight();</span><br><span class="line">            float3 lightDir &#x3D; normalize(light.direction);</span><br><span class="line">            float3 normalWS &#x3D; normalize(i.normalWS);</span><br><span class="line">            float halfLambert &#x3D; dot(lightDir, normalWS) * 0.5f + 0.5f;</span><br><span class="line">            float4 ramp &#x3D; SAMPLE_TEXTURE2D(_RampTex, sampler_RampTex, float2(halfLambert, 0.5f));</span><br><span class="line"></span><br><span class="line">            return ramp * col * float4(light.color, 1);</span><br><span class="line">        &#125;</span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="AlphaTest"><a href="#AlphaTest" class="headerlink" title="AlphaTest"></a>AlphaTest</h1><h2 id="基础简介-1"><a href="#基础简介-1" class="headerlink" title="基础简介"></a>基础简介</h2><p>使用clip，在片元着色器对裁剪一些像素</p>
<h2 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;AlphaTest&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _BaseColor(&quot;BaseColor&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        [HDR]_BurnColor(&quot;BurnColor&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Cutoff (&quot;Cutoff&quot;, Range(0,1)) &#x3D; 0.5</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;TransparentCutout&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot; &quot;Queue&quot; &#x3D; &quot;AlphaTest&quot; &#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_RampTex);</span><br><span class="line">        SAMPLER(sampler_RampTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        float4 _BurnColor;</span><br><span class="line">        float _Cutoff;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv) * _BaseColor;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; step(_Cutoff, col.r)  &#x3D;  (_Cutoff &lt;&#x3D; col.r ? 1 : 0)</span><br><span class="line">            clip(step(_Cutoff, col.r) - 0.01);</span><br><span class="line">            col &#x3D; lerp(col, _BurnColor, step(col.r, saturate(_Cutoff + 0.1))) ;</span><br><span class="line">            return col;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><ul>
<li>clip()， 参数小于0则裁剪</li>
<li>step(a,b) 等价于  a &lt;= b ? 1 : 0， 用于优化shader代码中的if，else</li>
</ul>
<h1 id="AlphaBlend"><a href="#AlphaBlend" class="headerlink" title="AlphaBlend"></a>AlphaBlend</h1><h2 id="基础简介-2"><a href="#基础简介-2" class="headerlink" title="基础简介"></a>基础简介</h2><ol>
<li>关闭深度写入</li>
<li>渲染队列，渲染类型设置成Transparent 透明的</li>
<li>设置Blend</li>
</ol>
<h2 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;AlphaBlend&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _AlphaTex(&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot;&#123;&#125;</span><br><span class="line">        _BaseColor(&quot;BaseColor&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123; </span><br><span class="line">        Tags&#123;</span><br><span class="line"></span><br><span class="line">        &quot;RenderPipeline&quot; &#x3D; &quot;UniversalRenderPipeline&quot;</span><br><span class="line"></span><br><span class="line">         &quot;IgnoreProjector&quot; &#x3D; &quot;True&quot;</span><br><span class="line"></span><br><span class="line">         &quot;RenderType&quot; &#x3D; &quot;Transparent&quot;</span><br><span class="line"></span><br><span class="line">         &quot;Queue&quot; &#x3D; &quot;Transparent&quot;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        ZWrite Off</span><br><span class="line">        Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line">        TEXTURE2D(_AlphaTex);</span><br><span class="line">        SAMPLER(sampler_AlphaTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _AlphaTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float4 uv            : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS);</span><br><span class="line">            o.uv.xy &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.uv.zw &#x3D; TRANSFORM_TEX(i.uv, _AlphaTex);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv.xy) * _BaseColor;</span><br><span class="line">            float alpha &#x3D; SAMPLE_TEXTURE2D(_AlphaTex, sampler_AlphaTex, i.uv.zw).a;</span><br><span class="line">            return float4(col.rgb, alpha);</span><br><span class="line">        &#125;</span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><ul>
<li>“IgnoreProjector” = “True”， 忽视</li>
</ul>
<h1 id="多光源"><a href="#多光源" class="headerlink" title="多光源"></a>多光源</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><ul>
<li>首先需要获取多光源，通过GetAdditionalLightsCount()，GetAdditionalLight(index, positionWS)两个函数处理多光源</li>
<li>将主光源计算后的颜色，叠加所有叠加光源颜色输出</li>
</ul>
<h2 id="代码-5"><a href="#代码-5" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;MulLight&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _BaseColor (&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        [KeywordEnum(ON,OFF)]_ADD_LIGHT(&quot;AddLight&quot;,float) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 normalWS:TEXCOORD1; </span><br><span class="line">            float3 positionWS:TEXCOORD2;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.normalWS &#x3D; TransformObjectToWorldNormal(i.normalOS.xyz, true); </span><br><span class="line">            o.positionWS &#x3D; TransformObjectToWorld(i.positionOS.xyz);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            Light mylight &#x3D; GetMainLight(); </span><br><span class="line">            real4 LightColor &#x3D; real4(mylight.color, 1); </span><br><span class="line">            float3 lightDir &#x3D; normalize(mylight.direction);</span><br><span class="line">            float3 normalWS &#x3D; normalize(i.normalWS);</span><br><span class="line">            float halfLambert &#x3D; dot(normalWS, lightDir) * 0.5f + 0.5f;</span><br><span class="line">            float4 color &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv) * _BaseColor * halfLambert * LightColor;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; AddLight</span><br><span class="line">            float4 addLightColor &#x3D; float4(0,0,0,1);</span><br><span class="line"></span><br><span class="line">            #if _ADD_LIGHT_ON</span><br><span class="line">            int lightCount &#x3D; GetAdditionalLightsCount();</span><br><span class="line">            for (int index &#x3D; 0; index &lt; lightCount; index++)</span><br><span class="line">            &#123;</span><br><span class="line">                Light light &#x3D; GetAdditionalLight(index, i.positionWS);</span><br><span class="line">                addLightColor +&#x3D; (dot(normalWS, normalize(light.direction)) * 0.5f + 0.5f) </span><br><span class="line">                    * real4(light.color, 1) * light.distanceAttenuation * light.shadowAttenuation;</span><br><span class="line">            &#125;</span><br><span class="line">            #endif</span><br><span class="line"></span><br><span class="line">            return color + addLightColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            #pragma shader_feature _ADD_LIGHT_ON _ADD_LIGHT_OFF</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><ul>
<li>shader枚举开关：<br>[KeywordEnum(ON,OFF)]_ADD_LIGHT(“AddLight”,float) = 1   //定义shader中的枚举 只有ON,OFF两个选项<br>#pragma shader_feature _ADD_LIGHT_ON _ADD_LIGHT_OFF     //定义shader_feature 规则：参数名_枚举名 （需要把所有定义的选项都放进去）<br>#if _ADD_LIGHT_ON … #endif  使用</li>
</ul>
<h1 id="阴影投射和接收"><a href="#阴影投射和接收" class="headerlink" title="阴影投射和接收"></a>阴影投射和接收</h1><h2 id="基础-1"><a href="#基础-1" class="headerlink" title="基础"></a>基础</h2><ol>
<li><p>投射<br>使用官方写好的阴影投射Pass UsePass “Universal Render Pipeline/Lit/ShadowCaster”<br>使用官方写好的 不支持SRP Batcher， 因此自己写阴影投射Pass<br>参考”Packages/com.unity.render-pipelines.universal/Shaders/ShadowCasterPass.hlsl”</p>
</li>
<li><p>接收<br>TransformWorldToShadowCoord(i.positionWS)     //获得shadowcoord<br>GetMainLight(shadowcoord).shadowAttenuation   //获得阴影值<br>#pragma multi_compile _ _MAIN_LIGHT_SHADOWS //开启阴影<br>#pragma multi_compile _ _MAIN_LIGHT_SHADOWS_CASCADE //级联阴影<br>#pragma multi_compile _ _SHADOWS_SOFT //柔化阴影，得到软阴影 </p>
</li>
<li><p>额外光源阴影接收</p>
</li>
</ol>
<h2 id="代码-6"><a href="#代码-6" class="headerlink" title="代码"></a>代码</h2><ul>
<li><p>主光源阴影接收Shader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Shadow&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex(&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _GlossColor(&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Gloss(&quot;Gloss&quot;, Range(1, 256)) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _GlossColor;</span><br><span class="line">        float _Gloss;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 normalWS:TEXCOORD1;</span><br><span class="line">            float3 positionWS:TEXCOORD2;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.positionWS &#x3D; TransformObjectToWorld(i.positionOS.xyz);</span><br><span class="line">            o.normalWS &#x3D; TransformObjectToWorldNormal(i.normalOS.xyz, true);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            Light mylight &#x3D; GetMainLight(TransformWorldToShadowCoord(i.positionWS));</span><br><span class="line">            real4 LightColor &#x3D; real4(mylight.color, 1);</span><br><span class="line">            float3 lightDir &#x3D; normalize(mylight.direction);</span><br><span class="line">            float3 viewDir &#x3D; normalize(_WorldSpaceCameraPos.xyz - i.positionWS);</span><br><span class="line">            float3 worldNormal &#x3D; normalize(i.normalWS);</span><br><span class="line">            float phong &#x3D; pow(max(dot(reflect(-lightDir, worldNormal), viewDir), 0), _Gloss);</span><br><span class="line">            float blinnPhong &#x3D; pow(max(dot(normalize(lightDir + viewDir), worldNormal), 0), _Gloss);</span><br><span class="line"></span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">            float4 diffuse &#x3D; LightColor * col * max(dot(lightDir, worldNormal), 0) * mylight.shadowAttenuation;</span><br><span class="line">            float4 specular &#x3D; _GlossColor * blinnPhong * LightColor * mylight.shadowAttenuation;</span><br><span class="line">            return float4(specular.rgb + diffuse.rgb, col.a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            #pragma multi_compile _ _MAIN_LIGHT_SHADOWS &#x2F;&#x2F;开启阴影</span><br><span class="line">            #pragma multi_compile _ _MAIN_LIGHT_SHADOWS_CASCADE &#x2F;&#x2F;级联阴影</span><br><span class="line">            #pragma multi_compile _ _SHADOWS_SOFT &#x2F;&#x2F;柔化阴影，得到软阴影 </span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">        UsePass &quot;Universal Render Pipeline&#x2F;Lit&#x2F;ShadowCaster&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>额外光源阴影接收Shader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; AddLight</span><br><span class="line">float4 addLightColor &#x3D; float4(0, 0, 0, 1);</span><br><span class="line"></span><br><span class="line">#if _ADD_LIGHT_ON</span><br><span class="line">    #if defined(SHADOWS_SHADOWMASK) &amp;&amp; defined(LIGHTMAP_ON)</span><br><span class="line">        half4 shadowMask &#x3D; inputData.shadowMask;</span><br><span class="line">    #elif !defined (LIGHTMAP_ON)</span><br><span class="line">        half4 shadowMask &#x3D; unity_ProbesOcclusion;</span><br><span class="line">    #else</span><br><span class="line">        half4 shadowMask &#x3D; half4(1, 1, 1, 1);</span><br><span class="line">    #endif</span><br><span class="line"></span><br><span class="line">    int lightCount &#x3D; GetAdditionalLightsCount();</span><br><span class="line">    for (int index &#x3D; 0; index &lt; lightCount; index++)</span><br><span class="line">    &#123;</span><br><span class="line">        Light light &#x3D; GetAdditionalLight(index, i.positionWS, shadowMask);</span><br><span class="line">        addLightColor +&#x3D; (dot(normalWS, normalize(light.direction)) * 0.5f + 0.5f)</span><br><span class="line">            * real4(light.color, 1) * light.distanceAttenuation * light.shadowAttenuation;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
</li>
<li><p>主光源投射阴影</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;参考 &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;Shaders&#x2F;ShadowCasterPass.hlsl&quot;</span><br><span class="line">Pass</span><br><span class="line">&#123;</span><br><span class="line">    Name &quot;ShadowCaster&quot;</span><br><span class="line">    Tags&#123;&quot;LightMode&quot; &#x3D; &quot;ShadowCaster&quot;&#125;</span><br><span class="line"></span><br><span class="line">    ZWrite On</span><br><span class="line">    ZTest LEqual</span><br><span class="line">    ColorMask 0</span><br><span class="line"></span><br><span class="line">    HLSLPROGRAM</span><br><span class="line">    #pragma vertex VertShadowCaster</span><br><span class="line">    #pragma fragment FragShadowCaster</span><br><span class="line"></span><br><span class="line">    Varyings VertShadowCaster(Attributes i)</span><br><span class="line">    &#123;</span><br><span class="line">        Varyings o;</span><br><span class="line">        o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">        float3 positionWS &#x3D; TransformObjectToWorld(i.positionOS.xyz);</span><br><span class="line">        float3 normalWS &#x3D; TransformObjectToWorldNormal(i.normalOS.xyz, true);</span><br><span class="line">        Light light &#x3D; GetMainLight();</span><br><span class="line">        o.positionHS &#x3D; TransformWorldToHClip(ApplyShadowBias(positionWS, normalWS, light.direction.xyz));</span><br><span class="line">        </span><br><span class="line">        #if UNITY_REVERSED_Z</span><br><span class="line">            o.positionHS.z &#x3D; min(o.positionHS.z, o.positionHS.w * UNITY_NEAR_CLIP_VALUE);</span><br><span class="line">        #else</span><br><span class="line">            o.positionHS.z &#x3D; max(o.positionHS.z, o.positionHS.w * UNITY_NEAR_CLIP_VALUE);</span><br><span class="line">        #endif</span><br><span class="line">        return o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    half4 FragShadowCaster(Varyings i) :SV_Target</span><br><span class="line">    &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    ENDHLSL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h2><ul>
<li>查看源码思路，最终需要得到阴影值，从Light中看到shadowAttenuation是我们需要的<br>通过 GetMainLight(shadowcoord) 或者 GetMainLight(float4 shadowCoord, float3 positionWS, half4 shadowMask) 获得的阴影会被赋值<br>调用了Shadow.hlsl中的 MainLightRealtimeShadow 以及 MainLightShadow<br>查看其中判断的宏可以发现需要 MAIN_LIGHT_CALCULATE_SHADOWS， 全局搜索发现开启 _MAIN_LIGHT_SHADOWS 后会定义MAIN_LIGHT_CALCULATE_SHADOWS<br>函数网里面跟进可以看到_MAIN_LIGHT_SHADOWS_CASCADE _SHADOWS_SOFT 还有其他一些宏，看使用情况开启即可</li>
</ul>
<p>GetMainLight需要参数 shadowcoord， 在Shadow.hlsl 查找shadowcoord 可以找到几个函数，<br>再看参数和调用地方，可以确认TransformWorldToShadowCoord函数我们可以直接使用</p>
<ul>
<li>初次看URP源码，先记录下在初次使用时寻找关键函数的思路</li>
</ul>
<h1 id="序列帧"><a href="#序列帧" class="headerlink" title="序列帧"></a>序列帧</h1><h2 id="基础-2"><a href="#基础-2" class="headerlink" title="基础"></a>基础</h2><ul>
<li>将一张序列帧图片分块，按块采样显示，间隔一定时间切换下一块</li>
</ul>
<h2 id="代码-7"><a href="#代码-7" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;SequenceFrame&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _FrameRate(&quot;FrameRate&quot;,float) &#x3D; 10</span><br><span class="line">        _Sheet(&quot;Sheet&quot;,Vector) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float _FrameRate;</span><br><span class="line">        float4 _Sheet;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            float2 uv &#x3D; 0;</span><br><span class="line">            uv.x &#x3D;  i.uv.x &#x2F; _Sheet.x + frac(floor(_Time.y * _FrameRate) &#x2F; _Sheet.x);</span><br><span class="line">            uv.y &#x3D; i.uv.y &#x2F; _Sheet.y + 1 - frac(floor(_Time.y * _FrameRate &#x2F; _Sheet.x) &#x2F; _Sheet.y);</span><br><span class="line">            return SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, uv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h2><ul>
<li>frac函数：取小数，frac(x) = x - (int)x;</li>
<li>_Time获取变化时间</li>
<li>图片左下角为(0,0)点，因此y轴需要反转一下</li>
</ul>
<h1 id="广告牌"><a href="#广告牌" class="headerlink" title="广告牌"></a>广告牌</h1><h2 id="基础-3"><a href="#基础-3" class="headerlink" title="基础"></a>基础</h2><p>实现效果：正方向始终朝向相机<br>思路：顶点着色器变换顶点坐标，使得渲染出来的模型朝向相机</p>
<ol>
<li>将所有操作都放在模型空间，使用模型空间坐标作为锚点，则锚点为(0,0,0)</li>
<li>根据顶点坐标的(x,y,z)重新计算顶点坐标 pos = center + right * x + up * y + z * fwd;</li>
<li>需要得出right, up, fwd，fwd为朝向相机的方向，通过相机朝向可以推出，需要求right和up，<br>假设我们的广告牌正方向都朝上则up = (0, 1, 0)， right = cross(up, fwd)<br>再重新计算up = cross(fwd, right) 得到up,right,fwd， 将计算结果作为模型空间顶点坐标进行其他计算即可</li>
</ol>
<h2 id="代码-8"><a href="#代码-8" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;ADS&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _BaseColor (&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Transparent&quot; &quot;RenderType&quot; &#x3D; &quot;Transparent&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        ZWrite Off</span><br><span class="line">        Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">        Cull Off</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 normalWS:TEXCOORD1; </span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;重新计算顶点坐标</span><br><span class="line">            float3 cameraPosOS &#x3D; TransformWorldToObject(_WorldSpaceCameraPos.xyz);</span><br><span class="line">            float3 fwd &#x3D; normalize(cameraPosOS);</span><br><span class="line">            float3 up &#x3D; abs(fwd.y) &lt; 0.99f ? float3(0, 1, 0) : float3(0, 0, 1);</span><br><span class="line">            float3 right &#x3D; normalize(cross(up, fwd));</span><br><span class="line">            up &#x3D; normalize(cross(fwd, right));</span><br><span class="line">            float3x3 Matrix &#x3D; &#123; right, up, fwd &#125;;</span><br><span class="line">            float3 posOS &#x3D; mul(i.positionOS.xyz, Matrix); &#x2F;&#x2F; &#x3D; i.positionOS.x * right + i.positionOS.y * up + i.positionOS.z * fwd</span><br><span class="line"></span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(posOS);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.normalWS &#x3D; TransformObjectToWorldNormal(i.normalOS.xyz, true); </span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            Light mylight &#x3D; GetMainLight(); </span><br><span class="line">            real4 LightColor &#x3D; real4(mylight.color, 1); </span><br><span class="line">            float3 lightDir &#x3D; normalize(mylight.direction);</span><br><span class="line">            float lambert &#x3D; dot(normalize(i.normalWS), lightDir);</span><br><span class="line">            float halfLambert &#x3D; lambert * 0.5f + 0.5f;</span><br><span class="line"></span><br><span class="line">            float4 color &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">            return color * _BaseColor * halfLambert * LightColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h2><ul>
<li>广告牌核心思想就是做顶点变换</li>
<li>使用cross叉乘得垂直向量，unity中的叉乘使用左手法则</li>
</ul>
<h1 id="玻璃效果"><a href="#玻璃效果" class="headerlink" title="玻璃效果"></a>玻璃效果</h1><h2 id="基础-4"><a href="#基础-4" class="headerlink" title="基础"></a>基础</h2><ul>
<li><p>首先需要抓屏，Build-in中通过grab pass或者传入RT，<br>URP中_CameraColorTexture得到当前屏幕同等分辨率的图像，它在opaque模型和skybox渲染完成之后抓取<br>通过:TEXTURE2D(_CameraColorTexture);SAMPLER(sampler_CameraColorTexture);获取<br>使用_CameraColorTexture必须设置中打开Opaque Texture选项<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/01.png" alt="设置Opaque" title="设置Opaque"></p>
</li>
<li><p>采样屏幕图像需要屏幕坐标：ComputeScreenPos(positionCS);<br>i.screenPos.xy / i.screenPos.w; //获取屏幕UV，需要做齐次除法</p>
</li>
<li><p>应用法线，对采样点进行偏移，可以使用世界空间法线或者切线空间法线<br>世界空间的法线由世界空间确定，会随着模型的旋转而变化；<br>切线空间的法线不随着模型的旋转而变换；</p>
</li>
<li><p>由于_CameraColorTextrue在Opaque之后，但在Transparent之前，因此透明物体无法显示<br>因此可以利用RenderFeature，Render Objects设置一个”LightMode”=”Grab”，在透明物体之后执行的透明队列<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/02.png" alt="设置RenderFeature" title="设置RenderFeature"></p>
</li>
</ul>
<h2 id="代码-9"><a href="#代码-9" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Glass&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _NormalTex(&quot;Normal&quot;,2D) &#x3D; &quot;bump&quot;&#123;&#125;</span><br><span class="line">        _NormalScale(&quot;NormalScale&quot;,Range(0,1)) &#x3D; 1</span><br><span class="line">        _BaseColor(&quot;BaseColor&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Amount(&quot;amount&quot;,float) &#x3D; 100</span><br><span class="line">        [KeywordEnum(WS_N,TS_N)]_NORMAL_STAGE(&quot;NormalStage&quot;,float) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Transparent&quot; &quot;RenderType&quot; &#x3D; &quot;Transparent&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot; &#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_NormalTex);</span><br><span class="line">        SAMPLER(sampler_NormalTex);</span><br><span class="line">        SAMPLER(_CameraColorTexture);</span><br><span class="line">        float4 _CameraColorTexture_TexelSize;&#x2F;&#x2F;该向量是非本shader独有，不能放在常量缓冲区</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _NormalTex_ST;</span><br><span class="line">        float _NormalScale;</span><br><span class="line">        float _Amount;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float4 tangentOS:TANGENT;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float4 normalWS:TEXCOORD1;</span><br><span class="line">            float4 tangentWS:TEXCOORD2;</span><br><span class="line">            float4 BtangentWS:TEXCOORD3;</span><br><span class="line">            float4 screenPos:TEXCOORD4;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            &#x2F;&#x2F; 使用以下函数 快速获取坐标，法线变换结果 ShaderVariablesFunctions.hlsl 引用 Core.hlsl即可</span><br><span class="line">            VertexPositionInputs input &#x3D; GetVertexPositionInputs(i.positionOS.xyz);</span><br><span class="line">            o.positionHS &#x3D; input.positionCS;</span><br><span class="line"></span><br><span class="line">            VertexNormalInputs normalInput &#x3D; GetVertexNormalInputs(i.normalOS, i.tangentOS);</span><br><span class="line">            o.normalWS.xyz &#x3D; normalInput.normalWS;</span><br><span class="line">            o.tangentWS.xyz &#x3D; normalInput.tangentWS;</span><br><span class="line">            o.BtangentWS.xyz &#x3D; normalInput.bitangentWS;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 存一下世界空间坐标</span><br><span class="line">            o.tangentWS.w &#x3D; input.positionWS.x;</span><br><span class="line">            o.BtangentWS.w &#x3D; input.positionWS.y;</span><br><span class="line">            o.normalWS.w &#x3D; input.positionWS.z;</span><br><span class="line"></span><br><span class="line">            o.screenPos &#x3D; ComputeScreenPos(input.positionCS);</span><br><span class="line"></span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _NormalTex);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float4 norTex &#x3D; SAMPLE_TEXTURE2D(_NormalTex, sampler_NormalTex, i.uv);</span><br><span class="line">            float3 normalTS &#x3D; UnpackNormalScale(norTex, _NormalScale);</span><br><span class="line">            normalTS.z &#x3D; pow(1 - pow(normalTS.x, 2) - pow(normalTS.y, 2), 0.5f);    &#x2F;&#x2F;规范化</span><br><span class="line"></span><br><span class="line">#if _NORMAL_STAGE_WS_N</span><br><span class="line">            float3 positionWS &#x3D; float3(i.tangentWS.w, i.BtangentWS.w, i.normalWS.w);</span><br><span class="line">            float3x3 T2W &#x3D; &#123; i.tangentWS.xyz, i.BtangentWS.xyz, i.normalWS.xyz &#125;;</span><br><span class="line">            float3 normalWS &#x3D; mul(normalTS, T2W);</span><br><span class="line">            float2 SS_bias &#x3D; normalWS.xy * _Amount * _CameraColorTexture_TexelSize.xy;&#x2F;&#x2F;世界空间的法线由世界空间确定，会随着模型的旋转而变化</span><br><span class="line">#else</span><br><span class="line">            float2 SS_bias &#x3D; normalTS.xy * _Amount * _CameraColorTexture_TexelSize.xy;&#x2F;&#x2F;切线空间的法线不随着模型的旋转而变换</span><br><span class="line">#endif</span><br><span class="line">            float2 SS_texcoord &#x3D; i.screenPos.xy &#x2F; i.screenPos.w;&#x2F;&#x2F;获取屏幕UV</span><br><span class="line">            float4 glassColor &#x3D; tex2D(_CameraColorTexture, SS_texcoord + SS_bias);&#x2F;&#x2F;把最终的颜色输出到屏幕即可</span><br><span class="line"></span><br><span class="line">            return glassColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;Grab&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            #pragma shader_feature_local _NORMAL_STAGE_WS_N</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结-8"><a href="#总结-8" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>使用ShaderVariablesFunctions.hlsl中的通用函数：<br>GetVertexPositionInputs(positionOS)，GetVertexNormalInputs(normalOS, tangentOS)<br>快速计算法线坐标变换以及法线</p>
</li>
<li><p>_CameraColorTexture只在运行时生效</p>
</li>
<li><p>_TextureName_TexelSize：图片的宽高，这个声明在CBuffer外<br>x = 1.0/width<br>y = 1.0/height<br>z = width<br>w = height</p>
</li>
<li><p>_TextureName_ST：图片的Tilling 和 Offset<br>x,y 对应 Tilling的 x,y<br>z,w 对应 Offset的 x,y</p>
</li>
<li><p>利用RenderFeature设置特殊的渲染方式</p>
</li>
</ul>
<h1 id="屏幕深度，护盾特效"><a href="#屏幕深度，护盾特效" class="headerlink" title="屏幕深度，护盾特效"></a>屏幕深度，护盾特效</h1><h2 id="基础-5"><a href="#基础-5" class="headerlink" title="基础"></a>基础</h2><ul>
<li><p>获取屏幕深度图 _CameraDepthTexture;<br>TEXUTRE2D(_CameraDepthTexture); SAMPLER(sampler_CameraDepthTexture);<br>通过屏幕坐标采样：ComputeScreenPos(positionCS); 别忘了使用时齐次除法，这步操作通常再原片着色器</p>
</li>
<li><p>Linear01Depth(depth, _ZBufferParams) 获取0-1线性深度</p>
</li>
<li><p>URPSetting中需要打开深度图 <img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/01.png" alt="设置Opaque" title="设置Opaque"></p>
</li>
<li><p>护盾特效：需实现菲尼尔效果，扫光效果<br>菲尼尔效果 基础公式：F0 + (1 - F0) * pow(1.0 - dot(viewDirWS, normalWS), 5.0);<br>F0为材质的菲尼尔系数<br>通用沿y轴扫光效果：float flow=saturate(pow(1-abs(frac(i.positionWS.y<em>0.3-_Time.y</em>0.2)-0.5),10)<em>0.3);<br>float4 flowcolor=flow</em>_emissioncolor;</p>
</li>
</ul>
<h2 id="代码-10"><a href="#代码-10" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;DepthShield&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex(&quot;MainTex&quot;,2D) &#x3D; &quot;white&quot;&#123;&#125;</span><br><span class="line">        _BaseColor(&quot;BaseColor&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _F0 (&quot;F0&quot;, float) &#x3D; 0.01</span><br><span class="line">        _EmissionColor (&quot;EmissionColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Speed(&quot;Speed&quot;, float) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Transparent&quot; &quot;RenderType&quot; &#x3D; &quot;Transparent&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot; &#125;</span><br><span class="line">        Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_CameraDepthTexture);</span><br><span class="line">        SAMPLER(sampler_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        float4 _EmissionColor;</span><br><span class="line">        float _F0;</span><br><span class="line">        float _Speed;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float4 screenPos:TEXCOORD1;</span><br><span class="line">            float3 positionWS:TEXCOORD2;</span><br><span class="line">            float3 normalWS:TEXCOORD3;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            &#x2F;&#x2F; 使用以下函数 快速获取坐标，法线变换结果 ShaderVariablesFunctions.hlsl 引用 Core.hlsl即可</span><br><span class="line">            VertexPositionInputs input &#x3D; GetVertexPositionInputs(i.positionOS.xyz);</span><br><span class="line">            o.positionHS &#x3D; input.positionCS;</span><br><span class="line">            o.positionWS &#x3D; input.positionWS;</span><br><span class="line">            o.screenPos &#x3D; ComputeScreenPos(input.positionCS);</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            o.normalWS &#x3D; normalize(TransformObjectToWorldNormal(i.normalOS.xyz));</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float4 col &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv) * _BaseColor;</span><br><span class="line">            float2 uvSS &#x3D; i.screenPos.xy &#x2F; i.screenPos.w;&#x2F;&#x2F;获取屏幕UV</span><br><span class="line">            float4 depthColor &#x3D; SAMPLE_TEXTURE2D(_CameraDepthTexture, sampler_CameraDepthTexture, uvSS);</span><br><span class="line">            float screenDepth &#x3D; Linear01Depth(depthColor.a, _ZBufferParams);</span><br><span class="line"></span><br><span class="line">            float depth &#x3D; i.positionHS.z;</span><br><span class="line">            depth &#x3D; Linear01Depth(depth, _ZBufferParams);&#x2F;&#x2F;得到模型的线性深度</span><br><span class="line">            float edge &#x3D; saturate(depth - screenDepth + 0.005) * 100;&#x2F;&#x2F;计算接触光</span><br><span class="line"></span><br><span class="line">            float3 viewDirWS &#x3D; normalize(_WorldSpaceCameraPos.xyz - i.positionWS);</span><br><span class="line"></span><br><span class="line">            float fresnel &#x3D; _F0 + (1 - _F0) * pow(1 - dot(viewDirWS, i.normalWS), 5);</span><br><span class="line">            float flow &#x3D; saturate(pow(1 - abs(frac(i.positionWS.y * 0.3 - _Time.y * _Speed) - 0.5), 10) * 0.3);</span><br><span class="line">            float flow1 &#x3D; saturate(pow(1 - abs(frac(i.positionWS.y * 0.5 - _Time.y * _Speed) - 0.5), 10) * 0.5);</span><br><span class="line">            float flow2 &#x3D; saturate(pow(1 - abs(frac(i.positionWS.y * 0.7 - _Time.y * _Speed) - 0.5), 10) * 0.7);</span><br><span class="line">            float4 flowcolor &#x3D; (flow + flow1 + flow2) * _EmissionColor;</span><br><span class="line"></span><br><span class="line">            return float4(col.rgb, fresnel + edge) + flowcolor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结-9"><a href="#总结-9" class="headerlink" title="总结"></a>总结</h2><ul>
<li>_ZBufferParams:  UnityInput.hlsl <a target="_blank" rel="noopener" href="http://www.humus.name/temp/Linearize%20depth.txt">官方链接</a><br>// x = 1-far/near<br>// y = far/near<br>// z = x/far<br>// w = y/far<br>#if UNITY_REVERSED_Z<br>// x = -1+far/near<br>// y = 1<br>// z = x/far<br>// w = 1/far</li>
</ul>
<h1 id="特定物体描边效果"><a href="#特定物体描边效果" class="headerlink" title="特定物体描边效果"></a>特定物体描边效果</h1><h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv6735961?spm_id_from=333.999.0.0">urp管线的自学hlsl之路 第二十五篇 Render Feature制作特定模型外描边</a></p>
<h2 id="基础-6"><a href="#基础-6" class="headerlink" title="基础"></a>基础</h2><p>整理一下描边过程：</p>
<ol>
<li><p>获得基础纯色图：按层级/渲染队列，过滤出需要渲染的物体，返回纯色<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E6%8F%8F%E8%BE%B901.png" alt="基础纯色图" title="基础纯色图"></p>
</li>
<li><p>对纯色图进行模糊操作<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E6%8F%8F%E8%BE%B902.png" alt="纯色图模糊" title="纯色图模糊"></p>
</li>
<li><p>纯色模糊图 - 纯色图：得到外描边图<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E6%8F%8F%E8%BE%B903.png" alt="外描边图" title="外描边图"></p>
</li>
<li><p>实际上模糊图 - 纯色图，内部边缘也会有一段负数渐变区，<br>将其显示出来相当于内描边，取绝对值abs，可以得到内外描边效果图<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E6%8F%8F%E8%BE%B904.png" alt="内外描边图" title="内外描边图"></p>
</li>
<li><p>将描边图与原图叠加输出</p>
</li>
</ol>
<h2 id="代码-11"><a href="#代码-11" class="headerlink" title="代码"></a>代码</h2><ol>
<li><p>基础纯色图：<br>绘制之前需要设置一下输出目标：ConfigureTarget(temp);<br>最终是要将物体绘制出来：context.DrawRenderers(renderingData.cullResults, ref draw, ref filter);<br>设置FilteringSettings filter = new FilteringSettings(queue, layer);<br>设置DrawingSettings draw = CreateDrawingSettings(shaderTag, ref renderingData, renderingData.cameraData.defaultOpaqueSortFlags);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;第一个pass 绘制纯色的图像</span><br><span class="line">    class DrawSoildColorPass : ScriptableRenderPass</span><br><span class="line">    &#123;</span><br><span class="line">        Setting mysetting &#x3D; null;</span><br><span class="line">        OutlineRenderFeather SelectOutline &#x3D; null;</span><br><span class="line">        ShaderTagId shaderTag &#x3D; new ShaderTagId(&quot;DepthOnly&quot;);&#x2F;&#x2F;只有在这个标签LightMode对应的shader才会被绘制</span><br><span class="line">        FilteringSettings filter;</span><br><span class="line"></span><br><span class="line">        public DrawSoildColorPass(Setting setting, OutlineRenderFeather render)</span><br><span class="line">        &#123;</span><br><span class="line">            mysetting &#x3D; setting;</span><br><span class="line">            SelectOutline &#x3D; render;</span><br><span class="line"></span><br><span class="line">            renderPassEvent &#x3D; setting.passEvent;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;过滤设定</span><br><span class="line">            RenderQueueRange queue &#x3D; new RenderQueueRange();</span><br><span class="line">            queue.lowerBound &#x3D; Mathf.Min(setting.QueueMax, setting.QueueMin);</span><br><span class="line">            queue.upperBound &#x3D; Mathf.Max(setting.QueueMax, setting.QueueMin);</span><br><span class="line">            filter &#x3D; new FilteringSettings(queue, setting.layer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void Configure(CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor)</span><br><span class="line">        &#123;</span><br><span class="line">            int temp &#x3D; Shader.PropertyToID(&quot;_MyTempColor1&quot;);</span><br><span class="line"></span><br><span class="line">            RenderTextureDescriptor desc &#x3D; cameraTextureDescriptor;</span><br><span class="line">            cmd.GetTemporaryRT(temp, desc);</span><br><span class="line">            SelectOutline.solidcolorID &#x3D; temp;</span><br><span class="line">            ConfigureTarget(temp);  &#x2F;&#x2F;设置它的输出RT</span><br><span class="line">            ConfigureClear(ClearFlag.All, Color.black);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)</span><br><span class="line">        &#123;</span><br><span class="line">            mysetting.mat.SetColor(&quot;_SoildColor&quot;, mysetting.color);</span><br><span class="line">            CommandBuffer cmd &#x3D; CommandBufferPool.Get(&quot;提取固有色pass&quot;);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;绘制设定</span><br><span class="line">            var draw &#x3D; CreateDrawingSettings(shaderTag, ref renderingData, renderingData.cameraData.defaultOpaqueSortFlags);</span><br><span class="line">            draw.overrideMaterial &#x3D; mysetting.mat;</span><br><span class="line">            draw.overrideMaterialPassIndex &#x3D; 0;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;开始绘制（准备好了绘制设定和过滤设定）</span><br><span class="line">            context.DrawRenderers(renderingData.cullResults, ref draw, ref filter);</span><br><span class="line">            context.ExecuteCommandBuffer(cmd);</span><br><span class="line">            CommandBufferPool.Release(cmd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取原图<br>renderer.cameraColorTarget;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public override void AddRenderPasses(ScriptableRenderer renderer, ref RenderingData renderingData)</span><br><span class="line">&#123;</span><br><span class="line">    if(setting.mat !&#x3D; null)</span><br><span class="line">    &#123;</span><br><span class="line">        RenderTargetIdentifier sour &#x3D; renderer.cameraColorTarget;   &#x2F;&#x2F;原图</span><br><span class="line">        renderer.EnqueuePass(_DrawSoildColorPass);</span><br><span class="line">        _DrawBlurPass.Setup(sour);</span><br><span class="line">        renderer.EnqueuePass(_DrawBlurPass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>模糊图<br>拿到基础纯色图，进行模糊即可，模糊操作可以参考<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/poem_qianmo/article/details/105350519">高品质后处理：十种图像模糊算法的总结与实现</a><br><a href="%22%22">后处理效果汇总</a></p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">class DrawBlurPass : ScriptableRenderPass</span><br><span class="line">    &#123;</span><br><span class="line">        Setting setting &#x3D; null;</span><br><span class="line">        OutlineRenderFeather SelectOutline &#x3D; null;</span><br><span class="line">        RenderTargetIdentifier sour;</span><br><span class="line">        BlurBlitter _blurBlitter &#x3D; new BlurBlitter();</span><br><span class="line">        public DrawBlurPass(Setting setting, OutlineRenderFeather render)</span><br><span class="line">        &#123;</span><br><span class="line">            this.setting &#x3D; setting;</span><br><span class="line">            SelectOutline &#x3D; render;</span><br><span class="line"></span><br><span class="line">            renderPassEvent &#x3D; setting.passEvent;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Setup(RenderTargetIdentifier sour)</span><br><span class="line">        &#123;</span><br><span class="line">            this.sour &#x3D; sour;</span><br><span class="line"></span><br><span class="line">            if (this.setting.ColorType &#x3D;&#x3D; Setting.EColorType.INcolorON)</span><br><span class="line">            &#123;</span><br><span class="line">                this.setting.mat.EnableKeyword(&quot;_INCOLORON&quot;);</span><br><span class="line">                this.setting.mat.DisableKeyword(&quot;_INCOLOROFF&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                this.setting.mat.EnableKeyword(&quot;_INCOLOROFF&quot;);</span><br><span class="line">                this.setting.mat.DisableKeyword(&quot;_INCOLORON&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)</span><br><span class="line">        &#123;</span><br><span class="line">            CommandBuffer cmd &#x3D; CommandBufferPool.Get(&quot;颜色计算&quot;);</span><br><span class="line"></span><br><span class="line">            RenderTextureDescriptor renderTextureDescriptor &#x3D; renderingData.cameraData.cameraTargetDescriptor;</span><br><span class="line"></span><br><span class="line">            int SourID &#x3D; Shader.PropertyToID(&quot;_SourTex&quot;);</span><br><span class="line">            cmd.GetTemporaryRT(SourID, renderTextureDescriptor);</span><br><span class="line">            cmd.CopyTexture(sour, SourID);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;模糊处理</span><br><span class="line">            int BlurID &#x3D; Shader.PropertyToID(&quot;_BlurTex&quot;);</span><br><span class="line">            cmd.GetTemporaryRT(BlurID, renderTextureDescriptor);</span><br><span class="line">            _blurBlitter.SetSource(BlurID, renderTextureDescriptor);</span><br><span class="line"></span><br><span class="line">            _blurBlitter.downSample &#x3D; 1;</span><br><span class="line">            _blurBlitter.blurScale &#x3D; setting.blur;</span><br><span class="line">            _blurBlitter.iteratorCount &#x3D; setting.passloop;</span><br><span class="line">            _blurBlitter.blurType &#x3D; BlurType.Box;</span><br><span class="line"></span><br><span class="line">            _blurBlitter.Render(cmd);</span><br><span class="line"></span><br><span class="line">            cmd.Blit(SelectOutline.solidcolorID, sour, setting.mat, 1);&#x2F;&#x2F;在第1个pass里合并所有图像</span><br><span class="line"></span><br><span class="line">            cmd.ReleaseTemporaryRT(SelectOutline.solidcolorID);</span><br><span class="line">            cmd.ReleaseTemporaryRT(SourID);</span><br><span class="line">            cmd.ReleaseTemporaryRT(BlurID);</span><br><span class="line">            context.ExecuteCommandBuffer(cmd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>合并图像<br>两个Pass都比较简单，不多说明了<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Outline&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex(&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _SoildColor(&quot;SoildColor&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_SourTex);</span><br><span class="line">        SAMPLER(sampler_SourTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_BlurTex);</span><br><span class="line">        SAMPLER(sampler_BlurTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _SoildColor;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Pass 0 纯色</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line"></span><br><span class="line">            Varyings Vert(Attributes i)</span><br><span class="line">            &#123;</span><br><span class="line">                Varyings o;</span><br><span class="line">                o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">                o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">                return _SoildColor;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; Pass 1 合并图像</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert1</span><br><span class="line">            #pragma fragment Frag1</span><br><span class="line">            #pragma multi_compile_local _INCOLORON _INCOLOROFF</span><br><span class="line"></span><br><span class="line">            Varyings Vert1(Attributes i)</span><br><span class="line">            &#123;</span><br><span class="line">                Varyings o;</span><br><span class="line">                o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">                o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float4 Frag1(Varyings i) :SV_Target&#123;</span><br><span class="line">                float4 blur &#x3D; SAMPLE_TEXTURE2D(_BlurTex, sampler_BlurTex, i.uv);</span><br><span class="line">                float4 sour &#x3D; SAMPLE_TEXTURE2D(_SourTex, sampler_SourTex, i.uv);</span><br><span class="line">                float4 soild &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line"></span><br><span class="line">                real4 color;</span><br><span class="line">#if _INCOLORON</span><br><span class="line">                color &#x3D; abs(blur - soild) + sour;</span><br><span class="line">#elif _INCOLOROFF</span><br><span class="line">                color &#x3D; saturate(blur - soild) + sour;</span><br><span class="line">#endif</span><br><span class="line">                return color;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="总结-10"><a href="#总结-10" class="headerlink" title="总结"></a>总结</h2><ul>
<li>获取基础纯色图的过程，是一个基础过滤物体到渲染的过程，可以参考URP源码RenderObjectsPass.cs</li>
</ul>
<h1 id="边缘检测描边"><a href="#边缘检测描边" class="headerlink" title="边缘检测描边"></a>边缘检测描边</h1><h2 id="基础-7"><a href="#基础-7" class="headerlink" title="基础"></a>基础</h2><p>参考Unity Shader入门精要，12.3，13.4章节</p>
<ul>
<li>基础边缘检测</li>
</ul>
<ol>
<li><p>卷积：通常为2<em>2,3</em>3的方形区域，每个格子对应一个权重值，<br>采样一个像素点时，对其周围方形空间采样按权重值叠加后再除以个数得到当前像素值</p>
</li>
<li><p>常见的边缘检测算子：Roberts，Prewitt，Sobel等<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E5%B8%B8%E8%A7%81%E7%9A%84%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B%E7%AE%97%E5%AD%90.png" alt="常见的边缘检测算子" title="常见的边缘检测算子"></p>
</li>
<li><p>得到两个方向的梯度值，Gx，Gy<br>G = sqrt(Gx<em>Gx,Gy</em>Gy); 通常优化开方： G = abs(Gx) + abs(Gy)<br>G 值表示梯度值，梯度值越大表示越在边缘</p>
</li>
<li><p>检测结果分析<br>这种方式检测，会产生很多我们不希望的边缘线，如光照影响的，法线影响的，阴影影响的等<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E5%9F%BA%E7%A1%80%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B.png" alt="基础边缘检测" title="基础边缘检测"></p>
</li>
</ol>
<ul>
<li>通过深度和深度法线上进行边缘检测</li>
</ul>
<ol>
<li><p>需要获取深度图，以及深度法线图，通过_CameraDepthTexture可以获得深度图，但是URP不支持深度法线图<br>因此需要获得深度法线图：自定义RenderFeather，在不透明物体渲染之前使用”Hidden/Internal-DepthNormalsTexture”渲染一次，将图片存为”_CameraDepthNormalsTexture”</p>
</li>
<li><p>_CameraDepthNormalsTexture.xyz存法线信息，_CameraDepthNormalsTexture.w存深度信息，<br>UnityCG.cginc中定义： DecodeFloatRG 解码深度：线性深度 = z + w/255<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E7%9B%B8%E6%9C%BA%E6%B7%B1%E5%BA%A6%E6%B3%95%E7%BA%BF01.png" alt="DecodeFloatRG" title="DecodeFloatRG"></p>
</li>
<li><p>_CameraDepthNormalsTexutre.xyz法线信息并非真实法线，需要对其进行解码操作获得观察空间法线<br>UnityCG.cginc中定义：DecodeViewNormalStereo<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E7%9B%B8%E6%9C%BA%E6%B7%B1%E5%BA%A6%E6%B3%95%E7%BA%BF02.png" alt="DecodeViewNormalStereo" title="DecodeViewNormalStereo"></p>
</li>
<li><p>镜像对比方式：如像素(x,y+1)与(x,y-1),(x+1,y)与(x-1,y)<br>比较法线以及深度是否相同，相同返回1，不同返回0，代码里对应CheckSame函数，小于一定范围则视为相同</p>
</li>
<li><p>检测结果分析<br>可以明显看到这种方式比第一种方式减少了很多不必要的边缘线<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E6%B7%B1%E5%BA%A6%E6%B3%95%E7%BA%BF%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B.png" alt="深度法线边缘检测" title="深度法线边缘检测"></p>
</li>
</ol>
<h2 id="代码-12"><a href="#代码-12" class="headerlink" title="代码"></a>代码</h2><ul>
<li><p>基础边缘检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;OutlinePPS&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _EdgeColor (&quot;EdgeColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _EdgeOnly (&quot;EdgeOnly&quot;,Range(0,1)) &#x3D; 1</span><br><span class="line">        _BackgroundColor (&quot;BackgroundColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        Cull Off ZWrite Off ZTest Always</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _MainTex_TexelSize;</span><br><span class="line"></span><br><span class="line">        float4 _EdgeColor;</span><br><span class="line">        float4 _BackgroundColor;</span><br><span class="line">        float _EdgeOnly;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv[9]         : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 3*3区域uv</span><br><span class="line">            o.uv[0] &#x3D; i.uv + _MainTex_TexelSize.xy * (-1, -1);</span><br><span class="line">            o.uv[1] &#x3D; i.uv + _MainTex_TexelSize.xy * (0, -1);</span><br><span class="line">            o.uv[2] &#x3D; i.uv + _MainTex_TexelSize.xy * (1, -1);</span><br><span class="line">            o.uv[3] &#x3D; i.uv + _MainTex_TexelSize.xy * (-1, 0);</span><br><span class="line">            o.uv[4] &#x3D; i.uv + _MainTex_TexelSize.xy * (0, 0);</span><br><span class="line">            o.uv[5] &#x3D; i.uv + _MainTex_TexelSize.xy * (1, 0);</span><br><span class="line">            o.uv[6] &#x3D; i.uv + _MainTex_TexelSize.xy * (-1, 1);</span><br><span class="line">            o.uv[7] &#x3D; i.uv + _MainTex_TexelSize.xy * (0, 1);</span><br><span class="line">            o.uv[8] &#x3D; i.uv + _MainTex_TexelSize.xy * (1, 1);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float luminance(float3 color)</span><br><span class="line">        &#123;</span><br><span class="line">            return 0.2125*color.r + 0.7154*color.g + 0.0721*color.b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 主要用于描边检测</span><br><span class="line">        float sobel(Varyings i)&#x2F;&#x2F;定义索伯检测函数</span><br><span class="line">        &#123;</span><br><span class="line">            const float Gx[9] &#x3D; &#123; -1,-2,-1,0,0,0,1,2,1 &#125;;</span><br><span class="line">            const float Gy[9] &#x3D; &#123; -1,0,1,-2,0,2,-1,0,1 &#125;;</span><br><span class="line"></span><br><span class="line">            float texColor &#x3D; 0;</span><br><span class="line">            float edgeX &#x3D; 0;</span><br><span class="line">            float edgeY &#x3D; 0;</span><br><span class="line">            for (int it &#x3D; 0; it &lt; 9; it++)</span><br><span class="line">            &#123;</span><br><span class="line">                texColor &#x3D; luminance(SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv[it]));</span><br><span class="line">                edgeX +&#x3D; texColor * Gx[it];</span><br><span class="line">                edgeY +&#x3D; texColor * Gy[it];</span><br><span class="line">            &#125;</span><br><span class="line">            return 1 - abs(edgeX) - abs(edgeY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line"></span><br><span class="line">            float edge &#x3D; sobel(i);</span><br><span class="line">            float4 color &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv[4]);</span><br><span class="line"></span><br><span class="line">            float4 color1 &#x3D; lerp(_EdgeColor, color, edge);</span><br><span class="line">            float4 color2 &#x3D; lerp(_EdgeColor, _BackgroundColor, edge);</span><br><span class="line">            return lerp(color1, color2, _EdgeOnly);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过深度和深度法线边缘检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;OutlinePPSDepth&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _EdgeColor (&quot;EdgeColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _EdgeOnly (&quot;EdgeOnly&quot;,Range(0,1)) &#x3D; 1</span><br><span class="line">        _BackgroundColor (&quot;BackgroundColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _SampleDistance(&quot;SampleDistance&quot;,Range(0,1)) &#x3D; 1</span><br><span class="line">        _SensitivityDepth (&quot;SensitivityDepth&quot;,Range(0,3)) &#x3D; 1</span><br><span class="line">        _SensitivityNormals (&quot;SensitivityNormals&quot;,Range(0,3)) &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        Cull Off ZWrite Off ZTest Always</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_CameraDepthNormalsTexture);</span><br><span class="line">        SAMPLER(sampler_CameraDepthNormalsTexture);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _MainTex_TexelSize;</span><br><span class="line"></span><br><span class="line">        float4 _EdgeColor;</span><br><span class="line">        float4 _BackgroundColor;</span><br><span class="line">        float _EdgeOnly;</span><br><span class="line">        float _SampleDistance;</span><br><span class="line">        float _SensitivityDepth;</span><br><span class="line">        float _SensitivityNormals;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv         : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; i.uv;</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float CheckSame(float2 centerNormal, float centerDepth, float2 sampleNormal, float sampleDepth)</span><br><span class="line">        &#123;</span><br><span class="line">            float2 diffNormal &#x3D; abs(centerNormal - sampleNormal) * _SensitivityNormals;</span><br><span class="line">            float diffDepth &#x3D; abs(centerDepth - sampleDepth) * _SensitivityDepth;</span><br><span class="line"></span><br><span class="line">            int isSameNormal &#x3D; (diffNormal.x + diffNormal.y) &lt; 0.1f;</span><br><span class="line">            int isSameDepth &#x3D; diffDepth &lt; 0.1 * centerNormal;</span><br><span class="line">            return isSameNormal * isSameDepth ? 1.0 : 0.0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float DecodeFloatRG(float2 enc)</span><br><span class="line">        &#123;</span><br><span class="line">            float2 kDecodeDot &#x3D; float2(1.0, 1 &#x2F; 255.0);</span><br><span class="line">            return dot(enc, kDecodeDot);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float3 DecodeViewNormalStereo(float4 enc4)</span><br><span class="line">        &#123;</span><br><span class="line">            float kScale &#x3D; 1.7777;</span><br><span class="line">            float3 nn &#x3D; enc4.xyz * float3(2 * kScale, 2 * kScale, 0) + float3(-kScale, -kScale, 1);</span><br><span class="line">            float g &#x3D; 2.0 &#x2F; dot(nn.xyz, nn.xyz);</span><br><span class="line">            float3 n;</span><br><span class="line">            n.xy &#x3D; g * nn.xy;</span><br><span class="line">            n.z &#x3D; g - 1;</span><br><span class="line">            return n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float sobel(Varyings i)</span><br><span class="line">        &#123;</span><br><span class="line">            float2 uv[9];</span><br><span class="line">            float2 normal[9];</span><br><span class="line">            float depth[9];</span><br><span class="line"></span><br><span class="line">            uv[0] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (-1, -1);</span><br><span class="line">            uv[1] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (0, -1);</span><br><span class="line">            uv[2] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (1, -1);</span><br><span class="line">            uv[3] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (-1, 0);</span><br><span class="line">            uv[4] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (0, 0);</span><br><span class="line">            uv[5] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (1, 0);</span><br><span class="line">            uv[6] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (-1, 1);</span><br><span class="line">            uv[7] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (0, 1);</span><br><span class="line">            uv[8] &#x3D; i.uv + _SampleDistance * _MainTex_TexelSize.xy * (1, 1);</span><br><span class="line"></span><br><span class="line">            for (int it &#x3D; 0; it &lt; 9; it++)</span><br><span class="line">            &#123;</span><br><span class="line">                real4 depthnormalTex &#x3D; SAMPLE_TEXTURE2D(_CameraDepthNormalsTexture, sampler_CameraDepthNormalsTexture, uv[it]);</span><br><span class="line">                normal[it] &#x3D; depthnormalTex.xy; &#x2F;&#x2F;临时法线  没使用DecodeViewNormalStereo，使用后有问题...</span><br><span class="line">                depth[it] &#x3D; DecodeFloatRG(depthnormalTex.zw); &#x2F;&#x2F; depthnormalTex.z * 1.0 + depthnormalTex.w &#x2F; 255.0; &#x2F;&#x2F;得到线性深度</span><br><span class="line">            &#125;</span><br><span class="line">            float edge &#x3D; 1;</span><br><span class="line">           </span><br><span class="line">            edge *&#x3D; CheckSame(normal[0], depth[0], normal[8], depth[8]);</span><br><span class="line">            edge *&#x3D; CheckSame(normal[1], depth[1], normal[7], depth[7]);</span><br><span class="line">            edge *&#x3D; CheckSame(normal[2], depth[2], normal[6], depth[6]);</span><br><span class="line">            edge *&#x3D; CheckSame(normal[3], depth[3], normal[5], depth[5]);</span><br><span class="line"></span><br><span class="line">            return edge;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line"></span><br><span class="line">            float edge &#x3D; sobel(i);</span><br><span class="line">            float4 color &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line"></span><br><span class="line">            float4 mainColor &#x3D; lerp(_EdgeColor, color, edge);</span><br><span class="line">            float4 noMainColor &#x3D; lerp(_EdgeColor, _BackgroundColor, edge);</span><br><span class="line">            return lerp(mainColor, noMainColor, _EdgeOnly);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>深度法线RenderFeather</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.Rendering;</span><br><span class="line">using UnityEngine.Rendering.Universal;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 获取深度法线</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class DepthNormalsRenderFeather : ScriptableRendererFeature</span><br><span class="line">&#123;</span><br><span class="line">    class DepthNormalsRenderPass : ScriptableRenderPass</span><br><span class="line">    &#123;</span><br><span class="line">        private RenderTargetHandle destination &#123; get; set; &#125;</span><br><span class="line">        private Material depthNormalsMaterial &#x3D; null;</span><br><span class="line">        private FilteringSettings m_FilteringSettings;</span><br><span class="line">        ShaderTagId m_ShaderTagId &#x3D; new ShaderTagId(&quot;DepthOnly&quot;);</span><br><span class="line"></span><br><span class="line">        public DepthNormalsRenderPass(RenderQueueRange renderQueueRange, LayerMask layerMask, Material material)</span><br><span class="line">        &#123;</span><br><span class="line">            m_FilteringSettings &#x3D; new FilteringSettings(renderQueueRange, layerMask);</span><br><span class="line">            this.depthNormalsMaterial &#x3D; material;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Setup(RenderTargetHandle destination)</span><br><span class="line">        &#123;</span><br><span class="line">            this.destination &#x3D; destination;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void Configure(CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor)</span><br><span class="line">        &#123;</span><br><span class="line">            RenderTextureDescriptor descriptor &#x3D; cameraTextureDescriptor;</span><br><span class="line">            descriptor.depthBufferBits &#x3D; 32;</span><br><span class="line">            descriptor.colorFormat &#x3D; RenderTextureFormat.ARGB32;</span><br><span class="line"></span><br><span class="line">            cmd.GetTemporaryRT(destination.id, descriptor, FilterMode.Point);</span><br><span class="line">            ConfigureTarget(destination.Identifier());</span><br><span class="line">            ConfigureClear(ClearFlag.All, Color.black);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Here you can implement the rendering logic.</span><br><span class="line">        &#x2F;&#x2F; Use &lt;c&gt;ScriptableRenderContext&lt;&#x2F;c&gt; to issue drawing commands or execute command buffers</span><br><span class="line">        &#x2F;&#x2F; https:&#x2F;&#x2F;docs.unity3d.com&#x2F;ScriptReference&#x2F;Rendering.ScriptableRenderContext.html</span><br><span class="line">        &#x2F;&#x2F; You don&#39;t have to call ScriptableRenderContext.submit, the render pipeline will call it at specific points in the pipeline.</span><br><span class="line">        public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)</span><br><span class="line">        &#123;</span><br><span class="line">            CommandBuffer cmd &#x3D; CommandBufferPool.Get(&quot;深度法线获取pass&quot;);</span><br><span class="line">            using (new ProfilingSample(cmd, &quot;DepthNormals Prepass&quot;))</span><br><span class="line">            &#123;</span><br><span class="line">                context.ExecuteCommandBuffer(cmd);</span><br><span class="line">                cmd.Clear();</span><br><span class="line">                var sortFlags &#x3D; renderingData.cameraData.defaultOpaqueSortFlags;</span><br><span class="line">                var drawSettings &#x3D; CreateDrawingSettings(m_ShaderTagId, ref renderingData, sortFlags);</span><br><span class="line">                drawSettings.perObjectData &#x3D; PerObjectData.None;</span><br><span class="line"></span><br><span class="line">                ref CameraData cameraData &#x3D; ref renderingData.cameraData;</span><br><span class="line">                Camera camera &#x3D; cameraData.camera;</span><br><span class="line">                if (cameraData.isStereoEnabled)</span><br><span class="line">                    context.StartMultiEye(camera);</span><br><span class="line"></span><br><span class="line">                drawSettings.overrideMaterial &#x3D; depthNormalsMaterial;</span><br><span class="line"></span><br><span class="line">                context.DrawRenderers(renderingData.cullResults, ref drawSettings,</span><br><span class="line">                  ref m_FilteringSettings);</span><br><span class="line"></span><br><span class="line">                cmd.SetGlobalTexture(&quot;_CameraDepthNormalsTexture&quot;, destination.id);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            context.ExecuteCommandBuffer(cmd);</span><br><span class="line">            CommandBufferPool.Release(cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Cleanup any allocated resources that were created during the execution of this render pass.</span><br><span class="line">        public override void OnCameraCleanup(CommandBuffer cmd)</span><br><span class="line">        &#123;</span><br><span class="line">            if (destination !&#x3D; RenderTargetHandle.CameraTarget)</span><br><span class="line">            &#123;</span><br><span class="line">                cmd.ReleaseTemporaryRT(destination.id);</span><br><span class="line">                destination &#x3D; RenderTargetHandle.CameraTarget;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepthNormalsRenderPass m_ScriptablePass;</span><br><span class="line">    RenderTargetHandle depthNormalsTexture;</span><br><span class="line">    Material depthNormalsMaterial;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;inheritdoc&#x2F;&gt;</span><br><span class="line">    public override void Create()</span><br><span class="line">    &#123;</span><br><span class="line">        depthNormalsMaterial &#x3D; CoreUtils.CreateEngineMaterial(&quot;Hidden&#x2F;Internal-DepthNormalsTexture&quot;);</span><br><span class="line">        m_ScriptablePass &#x3D; new DepthNormalsRenderPass(RenderQueueRange.opaque, -1, depthNormalsMaterial);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Configures where the render pass should be injected.</span><br><span class="line">        m_ScriptablePass.renderPassEvent &#x3D; RenderPassEvent.AfterRenderingPrePasses;</span><br><span class="line">        depthNormalsTexture.Init(&quot;_CameraDepthNormalsTexture&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Here you can inject one or multiple render passes in the renderer.</span><br><span class="line">    &#x2F;&#x2F; This method is called when setting up the renderer once per-camera.</span><br><span class="line">    public override void AddRenderPasses(ScriptableRenderer renderer, ref RenderingData renderingData)</span><br><span class="line">    &#123;</span><br><span class="line">        m_ScriptablePass.Setup(depthNormalsTexture);</span><br><span class="line">        renderer.EnqueuePass(m_ScriptablePass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结-11"><a href="#总结-11" class="headerlink" title="总结"></a>总结</h2><ul>
<li>URP并不支持深度法线图，通过RenderFeather自己生成一张并设置为全局变量</li>
<li>代码中并没有使用DecodeViewNormalStereo函数，在测试过程中使用DecodeViewNormalStereo解码，实际效果不知道为什么出现问题(待解决)<br>但是可以直接使用为解码的法线xy，因为计算过程xy与解码后成正比，不影响实际结果</li>
</ul>
<h1 id="科幻扫描效果"><a href="#科幻扫描效果" class="headerlink" title="科幻扫描效果"></a>科幻扫描效果</h1><h2 id="链接-1"><a href="#链接-1" class="headerlink" title="链接"></a>链接</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv6658281?spm_id_from=333.999.0.0">urp管线的自学hlsl之路 第二十三篇 科幻扫描效果前篇</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv6672641?spm_id_from=333.999.0.0">urp管线的自学hlsl之路 第二十四篇 科幻扫描效果后篇</a></p>
<h2 id="基础-8"><a href="#基础-8" class="headerlink" title="基础"></a>基础</h2><ol>
<li><p>首先要知道这是一个后处理，我们要做的是在屏幕上画线，再附加扫描<br>再屏幕上画线条需要区分可画区域与不可画区域，通过深度图来区分，只有有深度的地方才需要画线<br>画线需要与世界坐标系的x，y，z轴对应，目前我们不知道屏幕图像上的一点在世界坐标系的位置，<br>因此第一步需要计算屏幕像素点在世界坐标的实际位置，即重建世界坐标系。</p>
</li>
<li><p>世界坐标通过深度值，相机世界坐标以及一个朝向确定： positionWS = _WorldSpaceCameraPos + depth * Direction;  求：Direction<br>这个过程相当于NDC反运算，通过near，far，fov计算 相机到近平面四个顶点的向量<br>计算过程：height = near * tan(fov / 2);<br>width = height * camera.aspect;     //aspect为屏幕高宽比<br>fwd = camera.fwd * near;<br>right = camera.right * width;<br>up = camera.up * height;<br>四个向量为：<br>BottomLeft = fwd - right - up;<br>BottomRight = fwd + right - up;<br>UpLeft = fwd - right + up;<br>UpRight = fwd + right + up;<br>将结果线性变换：<br>float size = BottomLeft.magnitude / near;<br>BottomLeft = BottomLeft.normalize * size;<br>BottomRight = BottomRight.normalize * size;<br>UpLeft = UpLeft.normalize * size;<br>UpRight = UpRight.normalize * size;<br>将结果通过RenderFeature传入材质中。</p>
</li>
<li><p>基于x,y,z轴画线：</p>
</li>
</ol>
<ul>
<li>uv从左下角(0,0)到右上角(1,1)，将屏幕划分为四个区域，分别取上面以及计算好的向量<br>这时候将渲染屏幕大小的片，其对应有四个顶点，按照uv划分设置朝向，<br>在片元着色器中，每个像素得到的朝向是经过四个顶点朝向插值完的结果，因此得到相机到像素世界坐标的朝向以及长度<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int t &#x3D; 0;</span><br><span class="line">if (i.uv.x &lt; 0.5 &amp;&amp; i.uv.y &lt; 0.5)   &#x2F;&#x2F; 左下</span><br><span class="line">    t &#x3D; 0;</span><br><span class="line">else if (i.uv.x &gt; 0.5 &amp;&amp; i.uv.y &lt; 0.5)  &#x2F;&#x2F; 右下</span><br><span class="line">    t &#x3D; 1;</span><br><span class="line">else if (i.uv.x &gt; 0.5 &amp;&amp; i.uv.y &gt; 0.5)  &#x2F;&#x2F; 左上</span><br><span class="line">    t &#x3D; 2; </span><br><span class="line">else    &#x2F;&#x2F; 右上</span><br><span class="line">    t &#x3D; 3;</span><br><span class="line">o.Direction &#x3D; _Matrix[t].xyz;</span><br></pre></td></tr></table></figure></li>
<li>通过上面的分析得到向量后，能直接得到positionWS = _WorldSpaceCameraPos + depth * Direction + float3(0.01,0.01,0.01); //增加一点偏移是画出线显示在实际物体上面<br>输出positionWS查看效果：重新构建的世界坐标系将屏幕划分成四块<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E7%A7%91%E6%8A%80%E6%89%AB%E6%8F%8F01.png" alt="positionWS效果" title="positionWS效果"><br>将positionWS取frac，0-1：变成条状了<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E7%A7%91%E6%8A%80%E6%89%AB%E6%8F%8F02.png" alt="frac效果" title="frac效果"><br>使用step裁剪掉大部分0.98：最后就变成了线，可以看到3种类型线，分别对应x，y，z轴<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E7%A7%91%E6%8A%80%E6%89%AB%E6%8F%8F03.png" alt="step + frac效果" title="step + frac效果"><br>赋予颜色：线条变得更加明显了，这些线就代表世界坐标重构之后的x，y，z轴，其对应间隔为1<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float3 Line &#x3D; step(0.98, frac(positionWS));</span><br><span class="line">float3 LineColor &#x3D; Line.x * _ColorX + Line.y * _ColorY + Line.z * _ColorZ;</span><br></pre></td></tr></table></figure>
<img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E7%A7%91%E6%8A%80%E6%89%AB%E6%8F%8F04.png" alt="赋予颜色" title="赋予颜色"></li>
</ul>
<ol start="4">
<li><p>描边：通过上面学习的基于屏幕深度，深度法线做描边检测即可</p>
</li>
<li><p>扫描效果：类似上面做过的护盾扫描效果<br>float flow=saturate(pow(1-abs(frac(i.positionWS.y<em>0.3-_Time.y</em>0.2)-0.5),10)<em>0.3);<br>对其魔改一下，原来的效果为，0-1-0的渐变，扫描时我们通常使用1-0渐变，因此舍弃一部分渐变：<br>float mask=saturate(pow(abs(frac(positionWS.x + _Time.y</em>0.2)-0.75),10)*0.3);</p>
</li>
</ol>
<h2 id="代码-13"><a href="#代码-13" class="headerlink" title="代码"></a>代码</h2><ul>
<li><p>RenderFeature</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.Rendering;</span><br><span class="line">using UnityEngine.Rendering.Universal;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 科幻扫描效果</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class ScanRenderFeather : ScriptableRendererFeature</span><br><span class="line">&#123;</span><br><span class="line">    class ScanRenderPass : ScriptableRenderPass</span><br><span class="line">    &#123;</span><br><span class="line">        private Setting setting;</span><br><span class="line">        private RenderTargetIdentifier source;</span><br><span class="line">        private Material mat;</span><br><span class="line"></span><br><span class="line">        public void Setup(Setting setting)</span><br><span class="line">        &#123;</span><br><span class="line">            this.setting &#x3D; setting;</span><br><span class="line"></span><br><span class="line">            mat &#x3D; new Material(setting.shader);</span><br><span class="line">            renderPassEvent &#x3D; setting.Event;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Set(RenderTargetIdentifier source)</span><br><span class="line">        &#123;</span><br><span class="line">            this.source &#x3D; source;</span><br><span class="line">            mat.SetColor(&quot;_ColorX&quot;, setting.ColorX);</span><br><span class="line">            mat.SetColor(&quot;_ColorY&quot;, setting.ColorY);</span><br><span class="line">            mat.SetColor(&quot;_ColorZ&quot;, setting.ColorZ);</span><br><span class="line">            mat.SetColor(&quot;_ColorEdge&quot;, setting.ColorEdge);</span><br><span class="line">            mat.SetColor(&quot;_OutlineColor&quot;, setting.ColorOutline);</span><br><span class="line">            mat.SetFloat(&quot;_Width&quot;, setting.Width);</span><br><span class="line">            mat.SetFloat(&quot;_Spacing&quot;, setting.Spacing);</span><br><span class="line">            mat.SetFloat(&quot;_Speed&quot;, setting.Speed);</span><br><span class="line">            mat.SetFloat(&quot;_EdgeSample&quot;, setting.EdgeSample);</span><br><span class="line">            mat.SetFloat(&quot;_NormalSensitivity&quot;, setting.NormalSensitivity);</span><br><span class="line">            mat.SetFloat(&quot;_DepthSensitivity&quot;, setting.DepthSensitivity);</span><br><span class="line"></span><br><span class="line">            if (setting.AXIS &#x3D;&#x3D; AxisType.X)</span><br><span class="line">            &#123;</span><br><span class="line">                mat.DisableKeyword(&quot;_AXIS_Y&quot;);</span><br><span class="line">                mat.DisableKeyword(&quot;_AXIS_Z&quot;);</span><br><span class="line">                mat.EnableKeyword(&quot;_AXIS_X&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (setting.AXIS &#x3D;&#x3D; AxisType.Y)</span><br><span class="line">            &#123;</span><br><span class="line">                mat.DisableKeyword(&quot;_AXIS_Z&quot;);</span><br><span class="line">                mat.DisableKeyword(&quot;_AXIS_X&quot;);</span><br><span class="line">                mat.EnableKeyword(&quot;_AXIS_Y&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                mat.DisableKeyword(&quot;_AXIS_X&quot;);</span><br><span class="line">                mat.DisableKeyword(&quot;_AXIS_Y&quot;);</span><br><span class="line">                mat.EnableKeyword(&quot;_AXIS_Z&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; This method is called before executing the render pass.</span><br><span class="line">        &#x2F;&#x2F; It can be used to configure render targets and their clear state. Also to create temporary render target textures.</span><br><span class="line">        &#x2F;&#x2F; When empty this render pass will render to the active camera render target.</span><br><span class="line">        &#x2F;&#x2F; You should never call CommandBuffer.SetRenderTarget. Instead call &lt;c&gt;ConfigureTarget&lt;&#x2F;c&gt; and &lt;c&gt;ConfigureClear&lt;&#x2F;c&gt;.</span><br><span class="line">        &#x2F;&#x2F; The render pipeline will ensure target setup and clearing happens in a performant manner.</span><br><span class="line">        public override void OnCameraSetup(CommandBuffer cmd, ref RenderingData renderingData)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Here you can implement the rendering logic.</span><br><span class="line">        &#x2F;&#x2F; Use &lt;c&gt;ScriptableRenderContext&lt;&#x2F;c&gt; to issue drawing commands or execute command buffers</span><br><span class="line">        &#x2F;&#x2F; https:&#x2F;&#x2F;docs.unity3d.com&#x2F;ScriptReference&#x2F;Rendering.ScriptableRenderContext.html</span><br><span class="line">        &#x2F;&#x2F; You don&#39;t have to call ScriptableRenderContext.submit, the render pipeline will call it at specific points in the pipeline.</span><br><span class="line">        public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)</span><br><span class="line">        &#123;</span><br><span class="line">            int temp &#x3D; Shader.PropertyToID(&quot;temp&quot;);</span><br><span class="line">            CommandBuffer cmd &#x3D; CommandBufferPool.Get(&quot;扫描特效&quot;);</span><br><span class="line">            RenderTextureDescriptor desc &#x3D; renderingData.cameraData.cameraTargetDescriptor;</span><br><span class="line"></span><br><span class="line">            Camera cam &#x3D; renderingData.cameraData.camera;</span><br><span class="line">            float height &#x3D; cam.nearClipPlane * Mathf.Tan(Mathf.Deg2Rad * cam.fieldOfView * 0.5f);</span><br><span class="line">            Vector3 up &#x3D; cam.transform.up * height;</span><br><span class="line">            Vector3 right &#x3D; cam.transform.right * height * cam.aspect;</span><br><span class="line">            Vector3 forward &#x3D; cam.transform.forward * cam.nearClipPlane;</span><br><span class="line"></span><br><span class="line">            Vector3 ButtomLeft &#x3D; forward - right - up;</span><br><span class="line">            Vector3 ButtomRight &#x3D; forward + right - up;</span><br><span class="line">            Vector3 TopRight &#x3D; forward + right + up;</span><br><span class="line">            Vector3 TopLeft &#x3D; forward - right + up;</span><br><span class="line"></span><br><span class="line">            float scale &#x3D; ButtomLeft.magnitude &#x2F; cam.nearClipPlane;</span><br><span class="line">            ButtomLeft &#x3D; ButtomLeft.normalized * scale;</span><br><span class="line">            ButtomRight &#x3D; ButtomRight.normalized * scale;</span><br><span class="line">            TopRight &#x3D; TopRight.normalized * scale;</span><br><span class="line">            TopLeft &#x3D; TopLeft.normalized * scale;</span><br><span class="line"></span><br><span class="line">            Matrix4x4 MATRIX &#x3D; new Matrix4x4();</span><br><span class="line">            MATRIX.SetRow(0, ButtomLeft);</span><br><span class="line">            MATRIX.SetRow(1, ButtomRight);</span><br><span class="line">            MATRIX.SetRow(2, TopRight);</span><br><span class="line">            MATRIX.SetRow(3, TopLeft);</span><br><span class="line">            mat.SetMatrix(&quot;_Matrix&quot;, MATRIX);</span><br><span class="line"></span><br><span class="line">            cmd.GetTemporaryRT(temp, desc);</span><br><span class="line">            cmd.Blit(source, temp, mat);</span><br><span class="line">            cmd.Blit(temp, source);</span><br><span class="line">            context.ExecuteCommandBuffer(cmd);</span><br><span class="line">            cmd.ReleaseTemporaryRT(temp);</span><br><span class="line"></span><br><span class="line">            CommandBufferPool.Release(cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Cleanup any allocated resources that were created during the execution of this render pass.</span><br><span class="line">        public override void OnCameraCleanup(CommandBuffer cmd)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ScanRenderPass m_ScriptablePass;</span><br><span class="line"></span><br><span class="line">    public enum AxisType</span><br><span class="line">    &#123;</span><br><span class="line">        X,</span><br><span class="line">        Y,</span><br><span class="line">        Z</span><br><span class="line">    &#125;</span><br><span class="line">    [System.Serializable]</span><br><span class="line">    public class Setting</span><br><span class="line">    &#123;</span><br><span class="line">        public Shader shader &#x3D; null;</span><br><span class="line">        public RenderPassEvent Event &#x3D; RenderPassEvent.AfterRenderingTransparents;</span><br><span class="line">        [ColorUsage(true, true)] public Color ColorX &#x3D; Color.white;</span><br><span class="line">        [ColorUsage(true, true)] public Color ColorY &#x3D; Color.white;</span><br><span class="line">        [ColorUsage(true, true)] public Color ColorZ &#x3D; Color.white;</span><br><span class="line">        [ColorUsage(true, true)] public Color ColorEdge &#x3D; Color.white;</span><br><span class="line">        [ColorUsage(true, true)] public Color ColorOutline &#x3D; Color.white;</span><br><span class="line">        [Range(0, 0.2f), Tooltip(&quot;线框宽度&quot;)] public float Width &#x3D; 0.1f;</span><br><span class="line">        [Range(0.1f, 10), Tooltip(&quot;线框间距&quot;)] public float Spacing &#x3D; 1;</span><br><span class="line">        [Range(0, 10), Tooltip(&quot;滚动速度&quot;)] public float Speed &#x3D; 1;</span><br><span class="line">        [Range(0, 3), Tooltip(&quot;边缘采样半径&quot;)] public float EdgeSample &#x3D; 1;</span><br><span class="line">        [Range(0, 3), Tooltip(&quot;法线灵敏度&quot;)] public float NormalSensitivity &#x3D; 1;</span><br><span class="line">        [Range(0, 3), Tooltip(&quot;深度灵敏度&quot;)] public float DepthSensitivity &#x3D; 1;</span><br><span class="line">        [Tooltip(&quot;特效方向&quot;)] public AxisType AXIS;</span><br><span class="line">    &#125;</span><br><span class="line">    [SerializeField]</span><br><span class="line">    public Setting setting;</span><br><span class="line"></span><br><span class="line">    public override void Create()</span><br><span class="line">    &#123;</span><br><span class="line">        m_ScriptablePass &#x3D; new ScanRenderPass();</span><br><span class="line">        m_ScriptablePass.Setup(setting);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void AddRenderPasses(ScriptableRenderer renderer, ref RenderingData renderingData)</span><br><span class="line">    &#123;</span><br><span class="line">        m_ScriptablePass.Set(renderer.cameraColorTarget);</span><br><span class="line">        renderer.EnqueuePass(m_ScriptablePass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Shader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Scan&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        [HideInInspector] _MainTex(&quot;MainTex&quot;,2D) &#x3D; &quot;white&quot;&#123;&#125;</span><br><span class="line">        [HDR]_ColorX(&quot;ColorX&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        [HDR]_ColorY(&quot;ColorY&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        [HDR]_ColorZ(&quot;ColorZ&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        [HDR]_ColorEdge(&quot;ColorEdge&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Width(&quot;Width&quot;,float) &#x3D; 0.02</span><br><span class="line">        _Spacing(&quot;Spacing&quot;,float) &#x3D; 1</span><br><span class="line">        _Speed(&quot;Speed&quot;,float) &#x3D; 1</span><br><span class="line">        _EdgeSample(&quot;EdgeSample&quot;,Range(0,1)) &#x3D; 1</span><br><span class="line">        _NormalSensitivity(&quot;NormalSensitivity&quot;,float) &#x3D; 1</span><br><span class="line">        _DepthSensitivity(&quot;DepthSensitivity&quot;,float) &#x3D; 1</span><br><span class="line">        [HDR]_OutlineColor(&quot;OutlineColr&quot;,Color) &#x3D; (1,1,1,1)</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        Cull Off ZWrite Off ZTest Always</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 使用_CameraDepthNormalsTexture取代深度图</span><br><span class="line">        &#x2F;&#x2F; _CameraDepthNormalsTexture.xy法线信息，zw存深度信息，线性深度&#x3D;z+w&#x2F;255</span><br><span class="line">        TEXTURE2D(_CameraDepthTexture);</span><br><span class="line">        SAMPLER(sampler_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_CameraDepthNormalsTexture);</span><br><span class="line">        SAMPLER(sampler_CameraDepthNormalsTexture);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _MainTex_TexelSize;</span><br><span class="line">        real4 _ColorX;</span><br><span class="line">        real4 _ColorY;</span><br><span class="line">        real4 _ColorZ;</span><br><span class="line">        real4 _ColorEdge;</span><br><span class="line">        real4 _OutlineColor;</span><br><span class="line">        float _Width;</span><br><span class="line">        float _Spacing;</span><br><span class="line">        float _Speed;</span><br><span class="line">        float _EdgeSample;</span><br><span class="line">        float _NormalSensitivity;</span><br><span class="line">        float _DepthSensitivity;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        float4x4 _Matrix;</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float3 Direction:TEXCOORD1;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line">            o.uv &#x3D; i.uv;</span><br><span class="line">            int t &#x3D; 0;</span><br><span class="line">            if (i.uv.x &lt; 0.5 &amp;&amp; i.uv.y &lt; 0.5)</span><br><span class="line">                t &#x3D; 0;</span><br><span class="line">            else if (i.uv.x &gt; 0.5 &amp;&amp; i.uv.y &lt; 0.5)</span><br><span class="line">                t &#x3D; 1;</span><br><span class="line">            else if (i.uv.x &gt; 0.5 &amp;&amp; i.uv.y &gt; 0.5)</span><br><span class="line">                t &#x3D; 2;</span><br><span class="line">            else</span><br><span class="line">                t &#x3D; 3;</span><br><span class="line">            o.Direction &#x3D; _Matrix[t].xyz;</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 主要用于描边检测</span><br><span class="line">        int sobel(Varyings i)&#x2F;&#x2F;定义索伯检测函数</span><br><span class="line">        &#123;</span><br><span class="line">            real depth[4];</span><br><span class="line">            real2 normal[4];</span><br><span class="line">            float2 uv[4];&#x2F;&#x2F;计算采样需要的uv</span><br><span class="line"></span><br><span class="line">            uv[0] &#x3D; i.uv + float2(-1, -1) * _EdgeSample * _MainTex_TexelSize.xy;</span><br><span class="line">            uv[1] &#x3D; i.uv + float2(1, -1) * _EdgeSample * _MainTex_TexelSize.xy;</span><br><span class="line">            uv[2] &#x3D; i.uv + float2(-1, 1) * _EdgeSample * _MainTex_TexelSize.xy;</span><br><span class="line">            uv[3] &#x3D; i.uv + float2(1, 1) * _EdgeSample * _MainTex_TexelSize.xy;</span><br><span class="line">            for (int t &#x3D; 0; t &lt; 4; t++)</span><br><span class="line">            &#123;</span><br><span class="line">                real4 depthnormalTex &#x3D; SAMPLE_TEXTURE2D(_CameraDepthNormalsTexture, sampler_CameraDepthNormalsTexture, uv[t]);</span><br><span class="line">                normal[t] &#x3D; depthnormalTex.xy;&#x2F;&#x2F;得到临时法线</span><br><span class="line">                depth[t] &#x3D; depthnormalTex.z * 1.0 + depthnormalTex.w &#x2F; 255.0;&#x2F;&#x2F;得到线性深度</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;depth检测</span><br><span class="line">            int Dep &#x3D; abs(depth[0] - depth[3]) * abs(depth[1] - depth[2]) * _DepthSensitivity &gt; 0.01 ? 1 : 0;</span><br><span class="line">            &#x2F;&#x2F;normal检测</span><br><span class="line">            float2 nor &#x3D; abs(normal[0] - normal[3]) * abs(normal[1] - normal[2]) * _NormalSensitivity;</span><br><span class="line">            int Nor &#x3D; (nor.x + nor.y) &gt; 0.01 ? 1 : 0;</span><br><span class="line">            return saturate(Dep + Nor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            int outline &#x3D; sobel(i);</span><br><span class="line"></span><br><span class="line">            real4 tex &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">            real4 depthnormal &#x3D; SAMPLE_TEXTURE2D(_CameraDepthNormalsTexture, sampler_CameraDepthNormalsTexture, i.uv);</span><br><span class="line">            float depth01 &#x3D; depthnormal.z * 1.0 + depthnormal.w &#x2F; 255.0;</span><br><span class="line">            depth01 *&#x3D; _ProjectionParams.z;</span><br><span class="line">            &#x2F;&#x2F;float depth01 &#x3D; LinearEyeDepth(SAMPLE_TEXTURE2D(_CameraDepthTexture, sampler_CameraDepthTexture, i.uv).x, _ZBufferParams).x;</span><br><span class="line">            float3 positionWS &#x3D; _WorldSpaceCameraPos + depth01 * i.Direction + float3(0.01, 0.01, 0.01);    &#x2F;&#x2F;增加一点偏移是画出线显示在实际物体上面</span><br><span class="line">            float3 positionWS01 &#x3D; positionWS * _ZBufferParams.w;</span><br><span class="line">            float3 Line &#x3D; step(1 - _Width, frac(positionWS &#x2F; _Spacing));</span><br><span class="line">            float4 LineColor &#x3D; Line.x * _ColorX + Line.y * _ColorY + Line.z * _ColorZ + outline * _OutlineColor;</span><br><span class="line"></span><br><span class="line">#ifdef _AXIS_X</span><br><span class="line">            float mask &#x3D; saturate(pow(abs(frac(positionWS01.x * 10 + _Time.y * 0.1 * _Speed) - 0.53), 10) * 200);</span><br><span class="line">            float mask2 &#x3D; saturate(pow(abs(frac(positionWS01.x * 10 - _Time.y * 0.1 * _Speed) - 0.47), 10) * 200);</span><br><span class="line">            float mask3 &#x3D; saturate(pow(abs(frac(positionWS01.z * 10 + _Time.y * 0.1 * _Speed) - 0.53), 10) * 200);</span><br><span class="line">            float mask4 &#x3D; saturate(pow(abs(frac(positionWS01.z * 10 - _Time.y * 0.1 * _Speed) - 0.47), 10) * 200);</span><br><span class="line">            mask +&#x3D; mask2 + mask3 + mask4;</span><br><span class="line">            mask +&#x3D; step(0.95, mask);</span><br><span class="line">#elif _AXIS_Y</span><br><span class="line">            float mask &#x3D; saturate(pow(abs(frac(positionWS01.y * 10 + _Time.y * 0.1 * _Speed) - 0.75), 10) * 10);</span><br><span class="line">            mask +&#x3D; step(0.95, mask);</span><br><span class="line">#elif _AXIS_Z</span><br><span class="line">            float mask &#x3D; saturate(pow(abs(frac(positionWS01.z * 10 + _Time.y * 0.1 * _Speed) - 0.75), 10) * 10);</span><br><span class="line">            mask +&#x3D; step(0.95, mask);</span><br><span class="line">#endif</span><br><span class="line">            return tex * saturate(1 - mask) + (LineColor + _ColorEdge) * mask;  &#x2F;&#x2F; 扫描加入一个覆盖颜色更真实</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            #pragma multi_compile_local _AXIS_X _AXIS_Y _AXIS_Z</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结-12"><a href="#总结-12" class="headerlink" title="总结"></a>总结</h2><ul>
<li>通过屏幕像素点获得对应的世界坐标，在后处理中特别实用，如全局雾效，SSAO等</li>
<li>扫描效果与之前护盾扫描类似，扫描公式大概都以这样的为准，在此基础上进行魔改</li>
</ul>
<h1 id="屏幕炫光，更好的广告牌算法"><a href="#屏幕炫光，更好的广告牌算法" class="headerlink" title="屏幕炫光，更好的广告牌算法"></a>屏幕炫光，更好的广告牌算法</h1><h2 id="基础-9"><a href="#基础-9" class="headerlink" title="基础"></a>基础</h2><ol>
<li>使用模型空间(0,0,0,1)点做MV变换后得相机空间坐标，加上原先顶点的模型偏移，乘P矩阵得最终顶点坐标<br>基础广告牌已经完成，变得简单多了<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">float4 pivotWS &#x3D; mul(UNITY_MATRIX_M, float4(0, 0, 0, 1));</span><br><span class="line">float4 pivotVS &#x3D; mul(UNITY_MATRIX_V, pivotWS);</span><br><span class="line">o.positionHS &#x3D; mul(UNITY_MATRIX_P, pivotVS + float4(i.positionOS.xy, 0, 1));</span><br></pre></td></tr></table></figure></li>
<li>加入旋转以及缩放控制，目前对顶点进行变换并不会允许缩放以及旋转的控制<br>思路：在模型空间对其x，y坐标做缩放，旋转后(广告牌不需要z值)，再放入顶点变换计算中</li>
</ol>
<ul>
<li>二维旋转矩阵：<br>{<br>  cos(a),-sin(a),<br>  sin(a),cos(a)<br>}</li>
<li>获得GameObject的世界坐标缩放<br>float ScaleX = length(float3(UNITY_MATRIX_M[0].x, UNITY_MATRIX_M[1].x, UNITY_MATRIX_M[2].x));<br>float ScaleY = length(float3(UNITY_MATRIX_M[0].y, UNITY_MATRIX_M[1].y, UNITY_MATRIX_M[2].y));<br>float ScaleZ = length(float3(UNITY_MATRIX_M[0].z, UNITY_MATRIX_M[1].z, UNITY_MATRIX_M[2].z));</li>
<li>需要与unity顺序一致：先缩放，后旋转</li>
</ul>
<ol start="3">
<li>制作炫光，加入一个渐隐渐现效果</li>
</ol>
<ul>
<li>制作渐隐渐现只需要一个值来控制(alpha)，怎么求得alpha</li>
<li>物体中心点周围一个范围， 采样屏幕深度纹理，判断深度值，被遮挡不通过</li>
<li>透明值 = 没被遮挡数 / 采样总数    // alpha = passCount / totalSampleCount;</li>
<li>裁剪空间坐标，透除：pos.xy / pos.w</li>
</ul>
<h2 id="代码-14"><a href="#代码-14" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;ADS Pro&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        [HDR]_BaseColor(&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _Rotate(&quot;Rotate&quot;,Range(0,3.14)) &#x3D; 0</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;Queue&quot; &#x3D; &quot;Overlay&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        Blend One One</span><br><span class="line">        ZWrite Off</span><br><span class="line">        ZTest Always</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_CameraDepthTexture);</span><br><span class="line">        SAMPLER(sampler_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        float _Rotate;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float4 color         : COLOR;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">            float4 pivotWS &#x3D; mul(UNITY_MATRIX_M, float4(0, 0, 0, 1));</span><br><span class="line">            float4 pivotVS &#x3D; mul(UNITY_MATRIX_V, pivotWS);</span><br><span class="line">            float ScaleX &#x3D; length(float3(UNITY_MATRIX_M[0].x, UNITY_MATRIX_M[1].x, UNITY_MATRIX_M[2].x));</span><br><span class="line">            float ScaleY &#x3D; length(float3(UNITY_MATRIX_M[0].y, UNITY_MATRIX_M[1].y, UNITY_MATRIX_M[2].y));</span><br><span class="line">            &#x2F;&#x2F;float ScaleZ &#x3D; length(float3(UNITY_MATRIX_M[0].z, UNITY_MATRIX_M[1].z, UNITY_MATRIX_M[2].z));</span><br><span class="line"></span><br><span class="line">            float2x2 rotateMatrix &#x3D; &#123;cos(_Rotate),-sin(_Rotate),sin(_Rotate),cos(_Rotate)&#125;;</span><br><span class="line">            float2 pos &#x3D; i.positionOS.xy * float2(ScaleX, ScaleY);</span><br><span class="line">            pos &#x3D; mul(rotateMatrix, pos);</span><br><span class="line">            float4 positionVS &#x3D; pivotVS + float4(pos, 0, 1);</span><br><span class="line">            o.positionHS &#x3D; mul(UNITY_MATRIX_P, positionVS);</span><br><span class="line"></span><br><span class="line">            int sampleCount &#x3D; 3;</span><br><span class="line">            int axisCount &#x3D; sampleCount * 2 + 1;</span><br><span class="line">            float totalCount &#x3D; axisCount * axisCount;</span><br><span class="line">            float sampleRate &#x3D; 0.2;&#x2F;&#x2F;中心区域大小比例</span><br><span class="line">            float pivotDepth &#x3D; -pivotVS.z;&#x2F;&#x2F;取相机空间轴心的线性深度</span><br><span class="line">            float4 pivotCS &#x3D; mul(UNITY_MATRIX_P, pivotVS);</span><br><span class="line">            int passCount &#x3D; 0;</span><br><span class="line">            for (int x &#x3D; -sampleCount; x &lt;&#x3D; sampleCount; ++x)</span><br><span class="line">            &#123;</span><br><span class="line">                for (int y &#x3D; -sampleCount; y &lt;&#x3D; sampleCount; ++y)</span><br><span class="line">                &#123;</span><br><span class="line">                    float2 samplePos &#x3D; pivotCS.xy + o.positionHS.xy * sampleRate * float2(x, y) &#x2F; axisCount; &#x2F;&#x2F;裁剪空间采样坐标</span><br><span class="line">                    float2 SSuv &#x3D; samplePos &#x2F; o.positionHS.w * 0.5 + 0.5;&#x2F;&#x2F;把裁剪空间手动透除，变换到NDC空间下，并根据当前平台判断是否翻转y轴</span><br><span class="line">                    #ifdef UNITY_UV_STARTS_AT_TOP</span><br><span class="line">                    SSuv.y &#x3D; 1 - SSuv.y;</span><br><span class="line">                    #endif</span><br><span class="line"></span><br><span class="line">                    if (SSuv.x &lt; 0 || SSuv.x&gt;1 || SSuv.y &lt; 0 || SSuv.y&gt;1)</span><br><span class="line">                        continue;&#x2F;&#x2F;如果满足跳出本次循环进入下次循环</span><br><span class="line"></span><br><span class="line">                    float depth &#x3D; SAMPLE_TEXTURE2D_LOD(_CameraDepthTexture, sampler_CameraDepthTexture, SSuv, 0).x;</span><br><span class="line">                    depth &#x3D; LinearEyeDepth(depth, _ZBufferParams);</span><br><span class="line"></span><br><span class="line">                    passCount +&#x3D; step(pivotDepth, depth);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            o.color &#x3D; _BaseColor * _BaseColor.a * passCount &#x2F; totalCount;</span><br><span class="line">            o.color *&#x3D; smoothstep(0.1, 2, pivotDepth);</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            float4 color &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">            return i.color * color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &quot;RenderType&quot; &#x3D; &quot;Overlay&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结-13"><a href="#总结-13" class="headerlink" title="总结"></a>总结</h2><ul>
<li>取线性深度可以通过相机空间的-z值获取</li>
<li>判断平台差异，倒转y，UNITY_UV_STARTS_AT_TOP</li>
</ul>
<h1 id="屏幕空间贴花"><a href="#屏幕空间贴花" class="headerlink" title="屏幕空间贴花"></a>屏幕空间贴花</h1><h2 id="基础-10"><a href="#基础-10" class="headerlink" title="基础"></a>基础</h2><ol>
<li>Unity官方从2021.2版本开始才提供了 <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.1/manual/renderer-feature-decal.html">Unity URP官方文档2021.2版本</a></li>
</ol>
<ul>
<li>贴花组件 Decal Projector Component</li>
<li>Shader使用：Shader Graphs/Decal</li>
<li>使用时打开RenderFeather： Decal</li>
</ul>
<ol start="2">
<li><p>VisualEffectGraph粒子系统里提供了内置的ForwardDecal</p>
</li>
<li><p>自己实现一个屏幕空间贴画</p>
</li>
</ol>
<h2 id="代码-15"><a href="#代码-15" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;Decal&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">        _BaseColor (&quot;BaseColor&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">        _EdgeStretchPrevent (&quot;EdgeStretchPrevent&quot;, Range(-1,1)) &#x3D; 0</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;Queue&quot; &#x3D; &quot;Transparent-499&quot; &quot;RenderType&quot; &#x3D; &quot;Overlay&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot; &quot;DisableBatch&quot; &#x3D; &quot;True&quot;&#125;</span><br><span class="line">        Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_CameraDepthTexture);</span><br><span class="line">        SAMPLER(sampler_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        float _EdgeStretchPrevent;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float4 screenPos : TEXCOORD0;</span><br><span class="line">            float3 cameraPosOS:TEXCOORD1;</span><br><span class="line">            float4 cameraVertexDirOS:TEXCOORD2;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes i)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings o;</span><br><span class="line">            o.positionHS &#x3D; TransformObjectToHClip(i.positionOS.xyz);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 与ComputeScreenPos()函数效果相同</span><br><span class="line">            &#x2F;*o.screenPos &#x3D; o.positionHS * 0.5f;</span><br><span class="line">            o.screenPos.xy &#x3D;  float2(o.screenPos.x, o.screenPos.y * _ProjectionParams.x) + o.screenPos.w;</span><br><span class="line">            o.screenPos.zw &#x3D; o.positionHS.zw;*&#x2F;</span><br><span class="line"></span><br><span class="line">            o.screenPos &#x3D; ComputeScreenPos(o.positionHS);</span><br><span class="line"></span><br><span class="line">            float4 posVS &#x3D; mul(UNITY_MATRIX_V, mul(UNITY_MATRIX_M, i.positionOS));</span><br><span class="line">            o.cameraVertexDirOS.w &#x3D; -posVS.z;     &#x2F;&#x2F;w存线性深度</span><br><span class="line">            o.cameraVertexDirOS.xyz &#x3D; mul(UNITY_MATRIX_I_M, mul(UNITY_MATRIX_I_V, float4(posVS.xyz, 0))).xyz;  &#x2F;&#x2F;变换回模型空间坐标，但忽略了平移矩阵</span><br><span class="line"></span><br><span class="line">            o.cameraPosOS &#x3D; mul(UNITY_MATRIX_I_M, mul(UNITY_MATRIX_I_V, float4(0, 0, 0, 1))).xyz;&#x2F;&#x2F;计算模型空间下的相机坐标</span><br><span class="line">            return o;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">            float2 uv &#x3D; i.screenPos.xy &#x2F; i.screenPos.w;</span><br><span class="line">            float depth &#x3D; LinearEyeDepth(SAMPLE_TEXTURE2D(_CameraDepthTexture, sampler_CameraDepthTexture, uv).x, _ZBufferParams);</span><br><span class="line"></span><br><span class="line">            i.cameraVertexDirOS.xyz &#x2F;&#x3D; i.cameraVertexDirOS.w;</span><br><span class="line">            float3 decalPos &#x3D; i.cameraPosOS + i.cameraVertexDirOS.xyz * depth;&#x2F;&#x2F;模型空间下的计算：相机坐标+相机朝着顶点的射线（已透除）*相机空间的线性深度</span><br><span class="line"></span><br><span class="line">            float mask &#x3D; (abs(decalPos.x) &lt; 0.5 ? 1 : 0) * (abs(decalPos.y) &lt; 0.5 ? 1 : 0) * (abs(decalPos.z) &lt; 0.5 ? 1 : 0);</span><br><span class="line"></span><br><span class="line">            float3 decalNormal &#x3D; normalize(cross(ddy(decalPos), ddx(decalPos)));</span><br><span class="line"></span><br><span class="line">            mask *&#x3D; decalNormal.y &gt; 0.2 * _EdgeStretchPrevent ? 1 : 0;&#x2F;&#x2F;边缘拉伸的防止阈值</span><br><span class="line"></span><br><span class="line">            float2 YdecalUV &#x3D; decalPos.xz + 0.5; &#x2F;&#x2F; 模型空间下坐标偏移 -0.5 到 0.5， 因此+0.5使其 0 - 1范围</span><br><span class="line"></span><br><span class="line">            float4 tex &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, YdecalUV) * mask;</span><br><span class="line"></span><br><span class="line">            return tex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            #pragma target 3.0</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结-14"><a href="#总结-14" class="headerlink" title="总结"></a>总结</h2><ul>
<li>ddx，ddy函数解释：对屏幕坐标x和y方向的偏导数<br>ddx(v) = 该像素点右边的v值 - 该像素点的v值<br>ddy(v) = 该像素点下面的v值 - 该像素点的v值<br>ddx(float3(1,2,3)) = float3(0,0,0) //因为使用该shader的所有像素 输出的记录值都是 float3(1,2,3)那么差值就为float3(0,0,0)<br>即理解为：ddx(v)，在屏幕上水平方向横跨一个像素的v值变化量，ddy，则在垂直方向上b的变化量</li>
</ul>
<p>解释：代码中使用 float3 decalNormal = normalize(cross(ddy(decalPos), ddx(decalPos)));<br>拿到模型空间decalPos后，ddy(decalPos)求得其往下的向量，ddx(decalPos)求得往右的向量，相当于得到decalPos在其相对坐标上的的x，y向量，叉乘得到z向量(垂直与两个向量)<br>可以近似理解为：ddx(decalPos) = (u+1,v)求出来的decalPos - (u,v)求出来的decalPos，在使用中相当于pos2-pos1，得到pos1到pos2的向量</p>
<ul>
<li>防止以后绕晕了再记录一下，以下M，V代表变换矩阵，I_M，I_V代表转置<br>positionVS =  mul(v * mul(M, positionOS))； positionOS = mul(I_M, mul(I_V, positionVS);<br>将变换过程理解为： positionOS -&gt; M -&gt; V = positionVS； 那么回去需要原路返回：positionVS -&gt; I_V -&gt; I_M = positionOS;</li>
</ul>
<h1 id="SSAO屏幕空间环境光遮蔽"><a href="#SSAO屏幕空间环境光遮蔽" class="headerlink" title="SSAO屏幕空间环境光遮蔽"></a>SSAO屏幕空间环境光遮蔽</h1><h2 id="基础理论"><a href="#基础理论" class="headerlink" title="基础理论"></a>基础理论</h2><p>参考 <a href="mailto:&#x63;&#111;&#x6d;&#46;&#x75;&#110;&#x69;&#x74;&#x79;&#x2e;&#114;&#101;&#110;&#100;&#x65;&#x72;&#x2d;&#x70;&#x69;&#x70;&#x65;&#x6c;&#x69;&#x6e;&#x65;&#115;&#x2e;&#117;&#110;&#105;&#x76;&#101;&#114;&#x73;&#97;&#108;&#x40;&#49;&#x32;&#46;&#49;&#46;&#49;">&#x63;&#111;&#x6d;&#46;&#x75;&#110;&#x69;&#x74;&#x79;&#x2e;&#114;&#101;&#110;&#100;&#x65;&#x72;&#x2d;&#x70;&#x69;&#x70;&#x65;&#x6c;&#x69;&#x6e;&#x65;&#115;&#x2e;&#117;&#110;&#105;&#x76;&#101;&#114;&#x73;&#97;&#108;&#x40;&#49;&#x32;&#46;&#49;&#46;&#49;</a>\ShaderLibrary\SSAO.hlsl<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/46633896">环境遮罩之SSAO原理</a><br><a target="_blank" rel="noopener" href="https://github.com/wlgys8/URPLearn/tree/master/Assets/URPLearn/SSAO">URP屏幕空间环境光遮蔽后处理(SSAO)</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35312463/article/details/117150378">【光线追踪系列十六】基于着色点的正向半球随机方向生成</a></p>
<ul>
<li>首先需要明确一点将所有坐标都转换至相机空间操作。</li>
</ul>
<ol>
<li><p>通过屏幕uv获取像素深度值，在裁剪空间中深度值就为其z轴的值，根据uv以及depth重建像素在相机空间的坐标<br>屏幕uv从0到1，裁剪空间uv从-1到1，将uv*2-1，范围变换至-1到1就为裁剪空间xy坐标。<br>通过renderingData.cameraData.GetGPUProjectionMatrix()获得当前相机P矩阵，以及P逆矩阵<br>通过逆矩阵求得VS坐标，进行齐次除法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;根据UV和depth，重建像素在viewspace中的坐标</span><br><span class="line">float3 ReconstructPositionVS(float2 uv, float depth) &#123;</span><br><span class="line">    float4 positionInHS &#x3D; float4(uv * 2 - 1, depth, 1);</span><br><span class="line">    float4 positionVS &#x3D; mul(CustomInvProjMatrix, positionInHS);</span><br><span class="line">    positionVS &#x2F;&#x3D; positionVS.w;</span><br><span class="line">    return positionVS.xyz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>得到当前像素的VS坐标后，需要在沿其法线方向的半球中随机采样点，然后计算对当前像素的ao影响<br>规定半球半径_SampleRadius，采样点数量_SampleCount，随机半球可以参照<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35312463/article/details/117150378">【光线追踪系列十六】基于着色点的正向半球随机方向生成</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">float Random(float2 st) &#123;</span><br><span class="line">    return frac(sin(dot(st, float2(12.9898, 78.233))) * 43758.5453123);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float Random(float x) &#123;</span><br><span class="line">    return frac(sin(x) * 43758.5453123);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 随机球</span><br><span class="line">float3 RandomSphere(float3 positionVS, float index)</span><br><span class="line">&#123;</span><br><span class="line">    float r1 &#x3D; Random(positionVS.xy);</span><br><span class="line">    float r2 &#x3D; Random(index);</span><br><span class="line">    float z &#x3D; sqrt(1 - r2);</span><br><span class="line">    float th &#x3D; 2 * PI * r1;</span><br><span class="line">    float x &#x3D; cos(th) * sqrt(r2);</span><br><span class="line">    float y &#x3D; sin(th) * sqrt(r2);</span><br><span class="line">    return float3(x, y, z);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>先随机一个半球的单位向量，再将其转换至视觉空间，将偏移加载像素VS坐标上，通过偏移后的VS再获得当前屏幕uv，采样该uv随机点的深度值，再重新构建VS坐标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">float2 ReProjectToUV(float3 positionVS) &#123;</span><br><span class="line">    float4 positionHS &#x3D; mul(CustomProjMatrix, float4(positionVS, 1));</span><br><span class="line">    return (positionHS.xy &#x2F; positionHS.w + 1) * 0.5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 offset &#x3D; RandomSphere(positionVS, it);</span><br><span class="line">offset &#x3D; normalize(mul(TBN, offset));</span><br><span class="line">float3 samplePositionVS &#x3D; positionVS + offset * _SampleRadius;</span><br><span class="line">float2 sampleUV &#x3D; ReProjectToUV(samplePositionVS); </span><br><span class="line">float sampleDepth &#x3D; SampleDepth(sampleUV);</span><br><span class="line">float3 hitPositionVS &#x3D; ReconstructPositionVS(sampleUV, sampleDepth);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取到随机采样点后，计算该点对当前像素的ao影响值</p>
</li>
</ol>
<h2 id="代码-16"><a href="#代码-16" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;SSAO&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        ZTest Always ZWrite Off Cull Off</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line"></span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #pragma shader_feature __AO_DEBUG__</span><br><span class="line">        #pragma shader_feature _Blur</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Filtering.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS   : POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">            UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            UNITY_VERTEX_OUTPUT_STEREO</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes input)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Varyings output;</span><br><span class="line">            UNITY_SETUP_INSTANCE_ID(input);</span><br><span class="line">            UNITY_INITIALIZE_VERTEX_OUTPUT_STEREO(output);</span><br><span class="line">            output.positionHS &#x3D; TransformObjectToHClip(input.positionOS);</span><br><span class="line">            output.uv &#x3D; input.uv;</span><br><span class="line">            return output;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ENDHLSL</span><br><span class="line">        </span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line"></span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line"></span><br><span class="line">            TEXTURE2D_X_FLOAT(_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">            TEXTURE2D_X(_MainTex);</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_TexelSize;</span><br><span class="line">            float4x4 CustomProjMatrix;</span><br><span class="line">            float4x4 CustomInvProjMatrix;</span><br><span class="line">            float _Atten;</span><br><span class="line">            float _Contrast;</span><br><span class="line">            float _SampleRadius;</span><br><span class="line">            int _SampleCount;</span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line">            float Random(float2 st) &#123;</span><br><span class="line">                return frac(sin(dot(st, float2(12.9898, 78.233))) * 43758.5453123);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float Random(float x) &#123;</span><br><span class="line">                return frac(sin(x) * 43758.5453123);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float3 RandomSampleOffset(float2 uv, float index) &#123;</span><br><span class="line">                float2 alphaBeta &#x3D; float2(Random(uv) * PI * 2, Random(index) * PI);</span><br><span class="line">                float2 sin2;</span><br><span class="line">                float2 cos2;</span><br><span class="line">                sincos(alphaBeta, sin2, cos2);</span><br><span class="line">                return float3(cos2.y * cos2.x, sin2.y, cos2.y * sin2.x);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;根据UV和depth，重建像素在viewspace中的坐标</span><br><span class="line">            float3 ReconstructPositionVS(float2 uv, float depth) &#123;</span><br><span class="line">                float4 positionInHS &#x3D; float4(uv * 2 - 1, depth, 1);</span><br><span class="line">                float4 positionVS &#x3D; mul(CustomInvProjMatrix, positionInHS);</span><br><span class="line">                positionVS &#x2F;&#x3D; positionVS.w;</span><br><span class="line">                return positionVS.xyz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float2 ReProjectToUV(float3 positionVS) &#123;</span><br><span class="line">                float4 positionHS &#x3D; mul(CustomProjMatrix, float4(positionVS, 1));</span><br><span class="line">                return (positionHS.xy &#x2F; positionHS.w + 1) * 0.5;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float SampleDepth(float2 uv) &#123;</span><br><span class="line">                return LOAD_TEXTURE2D_X(_CameraDepthTexture, _MainTex_TexelSize.zw * uv).x;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line">                float4 color &#x3D; SAMPLE_TEXTURE2D_X(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">                float depth &#x3D; SampleDepth(i.uv);</span><br><span class="line"></span><br><span class="line">                float3 positionVS &#x3D; ReconstructPositionVS(i.uv, depth);</span><br><span class="line"></span><br><span class="line">                float3 tangentVS &#x3D; normalize(ddx(positionVS));</span><br><span class="line">                &#x2F;&#x2F;重建法线</span><br><span class="line">                float3 normalVS &#x3D; normalize(cross(ddy(positionVS), ddx(positionVS)));   &#x2F;&#x2F; 面法线</span><br><span class="line"></span><br><span class="line">                float3 binormalVS &#x3D; cross(normalVS, tangentVS);</span><br><span class="line">                float3x3 TBN &#x3D; &#123;tangentVS, binormalVS, normalVS&#125;;</span><br><span class="line"></span><br><span class="line">                float ao &#x3D; 0;</span><br><span class="line">                float rcpSampleCount &#x3D; rcp(_SampleCount);</span><br><span class="line">                for (int it &#x3D; 0; it &lt; (int)_SampleCount; ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 随机偏移值</span><br><span class="line">                    float3 offset &#x3D; RandomSampleOffset(i.uv, it);</span><br><span class="line">                    offset &#x3D; mul(TBN, offset);</span><br><span class="line">                    float3 samplePositionVS &#x3D; positionVS + offset * _SampleRadius * (1 + it) * rcpSampleCount;</span><br><span class="line">                    &#x2F;&#x2F;float4 samplePositionHS &#x3D; mul(CustomProjMatrix, float4(samplePositionVS, 1));</span><br><span class="line">                    &#x2F;&#x2F;float4 sampleScreenPos &#x3D; ComputeScreenPos(samplePositionHS);  &#x2F;&#x2F;ComputeScreenPos需要在顶点着色器使用，在片元计算结果不对劲</span><br><span class="line">                    &#x2F;&#x2F;float2 sampleUV &#x3D; sampleScreenPos.xy &#x2F; sampleScreenPos.w;</span><br><span class="line">                    float2 sampleUV &#x3D; ReProjectToUV(samplePositionVS); </span><br><span class="line"></span><br><span class="line">                    float sampleDepth &#x3D; SampleDepth(sampleUV);</span><br><span class="line">                    float3 hitPositionVS &#x3D; ReconstructPositionVS(sampleUV, sampleDepth);</span><br><span class="line"></span><br><span class="line">                    float3 hitOffset &#x3D; hitPositionVS - positionVS;</span><br><span class="line">                    float a &#x3D; max(0, dot(hitOffset, normalVS) - 0.001); &#x2F;&#x2F;0~radius</span><br><span class="line">                    float b &#x3D; dot(hitOffset, hitOffset) + 0.001; &#x2F;&#x2F;0~ radius^2</span><br><span class="line">                    ao +&#x3D; a * rcp(b); &#x2F;&#x2F; 0 ~ 1&#x2F;radius</span><br><span class="line">                &#125;</span><br><span class="line">                ao *&#x3D; _SampleRadius * rcpSampleCount;</span><br><span class="line">                ao &#x3D; PositivePow(ao * _Atten, _Contrast);</span><br><span class="line">                ao &#x3D; 1 - saturate(ao);</span><br><span class="line">                return ao;</span><br><span class="line">    #if __AO_DEBUG__ || _Blur</span><br><span class="line">                return float4(ao, ao, ao, 1);</span><br><span class="line">    #else</span><br><span class="line">                return ao * color;</span><br><span class="line">    #endif</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line"></span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment FragBlurH</span><br><span class="line"></span><br><span class="line">            #include &quot;..&#x2F;Blur&#x2F;Blur.hlsl&quot;</span><br><span class="line"></span><br><span class="line">            TEXTURE2D_X(_MainTex);</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_TexelSize;</span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line">            float4 FragBlurH(Varyings i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                return BoxBlur(_MainTex,i.uv * _MainTex_TexelSize.zw,2,float2(1,0));</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line"></span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment FragBlurV</span><br><span class="line"></span><br><span class="line">            #include &quot;..&#x2F;Blur&#x2F;Blur.hlsl&quot;</span><br><span class="line"></span><br><span class="line">            TEXTURE2D_X(_MainTex);</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_TexelSize;</span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line">            float4 FragBlurV(Varyings i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                return BoxBlur(_MainTex,i.uv * _MainTex_TexelSize.zw,2,float2(0,1));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line"></span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment FragComb</span><br><span class="line"></span><br><span class="line">            TEXTURE2D_X(_MainTex);</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_TexelSize;</span><br><span class="line"></span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line">            TEXTURE2D_X(_AOTex);</span><br><span class="line">            SAMPLER(sampler_AOTex);</span><br><span class="line"></span><br><span class="line">            float4 FragComb(Varyings i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                float4 color &#x3D; SAMPLE_TEXTURE2D_X(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">                float ao &#x3D; SAMPLE_TEXTURE2D_X(_AOTex, sampler_AOTex, i.uv);</span><br><span class="line">                #if __AO_DEBUG__</span><br><span class="line">                return ao;</span><br><span class="line">                #else</span><br><span class="line">                return ao * color;</span><br><span class="line">                #endif</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结-15"><a href="#总结-15" class="headerlink" title="总结"></a>总结</h2><p>屏幕空间操作指南：</p>
<ol>
<li><p>通过uv，depth，重构世界坐标，需要InvVP，vp逆矩阵，(相机空间坐标同理) 都先得到裁剪空间坐标再进行对应的变换：positionCS = P * V * M * positionOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">float3 ReconstructPositionWS(float2 uv, float depth) &#123;</span><br><span class="line">    float3 positionCS &#x3D; float3(uv * 2 - 1, depth);</span><br><span class="line">    float4 positionWS &#x3D; mul(_MatrixInvVP, float4(positionCS, 1));</span><br><span class="line">    positionWS &#x2F;&#x3D; positionWS.w;</span><br><span class="line">    return positionWS.xyz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>同样可以从世界坐标转换至裁剪坐标CS，裁剪坐标的xy范围(0-1)的uv值，z值为深度值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">float3 Reproject(float3 positionWS) &#123;</span><br><span class="line">    float4 positionCS &#x3D; mul(_MatrixVP, float4(positionWS, 1));</span><br><span class="line">    positionCS &#x2F;&#x3D; positionCS.w;</span><br><span class="line">    positionCS.xy &#x3D; (positionCS.xy + 1) * 0.5;</span><br><span class="line">    return positionCS.xyz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>裁剪空间得到屏幕uv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float2 pixelCoord &#x3D; positionCS.xy * _MainTex_TexelSize.zw;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="SSPR屏幕空间平面反射"><a href="#SSPR屏幕空间平面反射" class="headerlink" title="SSPR屏幕空间平面反射"></a>SSPR屏幕空间平面反射</h1><h2 id="基础-11"><a href="#基础-11" class="headerlink" title="基础"></a>基础</h2><ol>
<li>记录需要平面反射的平面，世界坐标以及法线，针对所有平面都有以下操作(一个坐标一个法线确定一个平面)</li>
<li>通过屏幕uv以及depth，重构世界坐标系</li>
<li>在ComputeShader中做反转变换：将世界坐标沿平面反转，得到新的反转点后再转换至屏幕空间得到uv2</li>
<li>uv2的颜色就是反射uv1的颜色</li>
<li>将ComputShader反转后的图像，用于平面的渲染，渲染是需要判断当前深度》屏幕深度，则渲染图像上的颜色</li>
</ol>
<h2 id="代码-17"><a href="#代码-17" class="headerlink" title="代码"></a>代码</h2><ul>
<li><p>shader：需要反射的平面，对其反射处理使用的shader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;URPLearn&#x2F;PlanarReflection&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        ZTest Always ZWrite Off Cull Off</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line"></span><br><span class="line">        Blend One One</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Filtering.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS   : POSITION;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">            UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float4 screenPos     : TEXCOORD1;</span><br><span class="line">            UNITY_VERTEX_OUTPUT_STEREO</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Varyings Vert(Attributes input)</span><br><span class="line">        &#123;</span><br><span class="line">            Varyings output;</span><br><span class="line">            UNITY_SETUP_INSTANCE_ID(input);</span><br><span class="line">            UNITY_INITIALIZE_VERTEX_OUTPUT_STEREO(output);</span><br><span class="line">            output.positionHS &#x3D; TransformObjectToHClip(input.positionOS);</span><br><span class="line">            output.uv &#x3D; input.uv;</span><br><span class="line">            output.screenPos &#x3D; ComputeScreenPos(output.positionHS);</span><br><span class="line">            return output;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_ReflectionTex);</span><br><span class="line">        TEXTURE2D(_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">        SAMPLER(sampler_ReflectionTex);</span><br><span class="line">        SAMPLER(sampler_CameraDepthTexture);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        float4 Frag(Varyings i) : SV_Target</span><br><span class="line">        &#123;</span><br><span class="line">            float2 screenUV &#x3D; i.screenPos.xy &#x2F; i.screenPos.w;</span><br><span class="line">            float depth &#x3D; SAMPLE_TEXTURE2D(_CameraDepthTexture, sampler_CameraDepthTexture, screenUV);</span><br><span class="line"></span><br><span class="line">            if (i.positionHS.z &gt;&#x3D; depth) &#123;</span><br><span class="line">                float4 color &#x3D; SAMPLE_TEXTURE2D_X(_ReflectionTex, sampler_ReflectionTex, screenUV);</span><br><span class="line">                return color;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">               discard;</span><br><span class="line">               return float4(0,0,0,0);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line"></span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RenderFeather：对标记的平面做反射以及再次渲染</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.Rendering;</span><br><span class="line">using UnityEngine.Rendering.Universal;</span><br><span class="line"></span><br><span class="line">namespace URPLearn</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public class SSPRRenderFeather : ScriptableRendererFeature</span><br><span class="line">    &#123;</span><br><span class="line">        class SSPRPlanarRenderPass : ScriptableRenderPass</span><br><span class="line">        &#123;</span><br><span class="line">            private Material _material;</span><br><span class="line">            private SSPRTexGenerator _ssprTexGenerator &#x3D; new SSPRTexGenerator();</span><br><span class="line"></span><br><span class="line">            private PlanarRendererGroups _planarRendererGroups &#x3D; new PlanarRendererGroups();</span><br><span class="line"></span><br><span class="line">            public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)</span><br><span class="line">            &#123;</span><br><span class="line">                CommandBuffer cmd &#x3D; CommandBufferPool.Get(&quot;SSPR-ReflectionTex&quot;);</span><br><span class="line"></span><br><span class="line">                ReflectPlane.GetVisiblePlanarGroups(_planarRendererGroups);</span><br><span class="line">                foreach (var group in _planarRendererGroups.PlanarRenderers)</span><br><span class="line">                &#123;</span><br><span class="line">                    cmd.Clear();</span><br><span class="line">                    var planarDescriptor &#x3D; group.descriptor;</span><br><span class="line">                    var renderers &#x3D; group.renderers;</span><br><span class="line">                    _ssprTexGenerator.Render(cmd, this.colorAttachment, ref renderingData, ref group.descriptor);</span><br><span class="line">                    cmd.SetRenderTarget(this.colorAttachment, this.depthAttachment);</span><br><span class="line">                    foreach (var rd in renderers)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cmd.DrawRenderer(rd, _material);</span><br><span class="line">                    &#125;</span><br><span class="line">                    _ssprTexGenerator.ReleaseTemporary(cmd);</span><br><span class="line">                    context.ExecuteCommandBuffer(cmd);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                cmd.Release();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            public void Setup(Material material, ComputeShader computeShader, bool blur, bool excludeBackground)</span><br><span class="line">            &#123;</span><br><span class="line">                _material &#x3D; material;</span><br><span class="line">                _ssprTexGenerator.BindCS(computeShader);</span><br><span class="line">                _ssprTexGenerator.enableBlur &#x3D; blur;</span><br><span class="line">                _ssprTexGenerator.excludeBackground &#x3D; excludeBackground;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [SerializeField]</span><br><span class="line">        private Material _material;</span><br><span class="line"></span><br><span class="line">        [SerializeField]</span><br><span class="line">        private ComputeShader _computeShader;</span><br><span class="line"></span><br><span class="line">        [SerializeField]</span><br><span class="line">        private bool _blur;</span><br><span class="line"></span><br><span class="line">        [SerializeField]</span><br><span class="line">        private bool _excludeBackground;</span><br><span class="line"></span><br><span class="line">        SSPRPlanarRenderPass m_ScriptablePass;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;inheritdoc&#x2F;&gt;</span><br><span class="line">        public override void Create()</span><br><span class="line">        &#123;</span><br><span class="line">            m_ScriptablePass &#x3D; new SSPRPlanarRenderPass();</span><br><span class="line"></span><br><span class="line">            m_ScriptablePass.renderPassEvent &#x3D; RenderPassEvent.BeforeRenderingPostProcessing;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Here you can inject one or multiple render passes in the renderer.</span><br><span class="line">        &#x2F;&#x2F; This method is called when setting up the renderer once per-camera.</span><br><span class="line">        public override void AddRenderPasses(ScriptableRenderer renderer, ref RenderingData renderingData)</span><br><span class="line">        &#123;</span><br><span class="line">            if (renderingData.cameraData.renderType !&#x3D; CameraRenderType.Base)</span><br><span class="line">            &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (_material &#x3D;&#x3D; null || _computeShader &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            m_ScriptablePass.Setup(_material, _computeShader, _blur, _excludeBackground);</span><br><span class="line">            m_ScriptablePass.ConfigureTarget(renderer.cameraColorTarget, renderer.cameraDepthTarget);</span><br><span class="line">            renderer.EnqueuePass(m_ScriptablePass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class SSPRTexGenerator</span><br><span class="line">    &#123;</span><br><span class="line">        private static class ShaderProperties</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            public static readonly int Result &#x3D; Shader.PropertyToID(&quot;_Result&quot;);</span><br><span class="line">            public static readonly int CameraColorTexture &#x3D; Shader.PropertyToID(&quot;_CameraColorTexture&quot;);</span><br><span class="line">            public static readonly int PlanarPosition &#x3D; Shader.PropertyToID(&quot;_PlanarPosition&quot;);</span><br><span class="line">            public static readonly int PlanarNormal &#x3D; Shader.PropertyToID(&quot;_PlanarNormal&quot;);</span><br><span class="line">            public static readonly int MatrixVP &#x3D; Shader.PropertyToID(&quot;_MatrixVP&quot;);</span><br><span class="line">            public static readonly int MatrixInvVP &#x3D; Shader.PropertyToID(&quot;_MatrixInvVP&quot;);</span><br><span class="line">            public static readonly int MainTexelSize &#x3D; Shader.PropertyToID(&quot;_MainTex_TexelSize&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private ComputeShader _computeShader;</span><br><span class="line">        private int _reflectionTexID;</span><br><span class="line"></span><br><span class="line">        private int _kernelClear;</span><br><span class="line">        private int _kernalPass1;</span><br><span class="line">        private int _kernalPass2;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 在生成反射贴图的时候，是否剔除掉无穷远的像素(例如天空盒)</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private bool _excludeBackground;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 模糊</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private bool _enableBlur;</span><br><span class="line"></span><br><span class="line">        private BlurBlitter _blurBlitter &#x3D; new BlurBlitter();</span><br><span class="line"></span><br><span class="line">        public SSPRTexGenerator(string reflectTexName &#x3D; &quot;_ReflectionTex&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            _reflectionTexID &#x3D; Shader.PropertyToID(reflectTexName);</span><br><span class="line">        &#125;</span><br><span class="line">        public void BindCS(ComputeShader cp)</span><br><span class="line">        &#123;</span><br><span class="line">            _computeShader &#x3D; cp;</span><br><span class="line">            this.UpdateKernelIndex();</span><br><span class="line">        &#125;</span><br><span class="line">        private void UpdateKernelIndex()</span><br><span class="line">        &#123;</span><br><span class="line">            _kernelClear &#x3D; _computeShader.FindKernel(&quot;Clear&quot;);</span><br><span class="line">            _kernalPass1 &#x3D; _computeShader.FindKernel(&quot;DrawReflectionTex1&quot;);</span><br><span class="line">            _kernalPass2 &#x3D; _computeShader.FindKernel(&quot;DrawReflectionTex2&quot;);</span><br><span class="line">            if (_excludeBackground)</span><br><span class="line">            &#123;</span><br><span class="line">                _kernalPass1 +&#x3D; 2;</span><br><span class="line">                _kernalPass2 +&#x3D; 2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public bool excludeBackground</span><br><span class="line">        &#123;</span><br><span class="line">            get</span><br><span class="line">            &#123;</span><br><span class="line">                return _excludeBackground;</span><br><span class="line">            &#125;</span><br><span class="line">            set</span><br><span class="line">            &#123;</span><br><span class="line">                _excludeBackground &#x3D; value;</span><br><span class="line">                if (_computeShader)</span><br><span class="line">                &#123;</span><br><span class="line">                    this.UpdateKernelIndex();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public bool enableBlur</span><br><span class="line">        &#123;</span><br><span class="line">            get</span><br><span class="line">            &#123;</span><br><span class="line">                return _enableBlur;</span><br><span class="line">            &#125;</span><br><span class="line">            set</span><br><span class="line">            &#123;</span><br><span class="line">                _enableBlur &#x3D; value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Render(CommandBuffer cmd, RenderTargetIdentifier id, ref RenderingData renderingData, ref PlanarDescriptor planarDescriptor)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            if (_computeShader &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(&quot;请设置CS&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var reflectionTexDes &#x3D; renderingData.cameraData.cameraTargetDescriptor;</span><br><span class="line">            reflectionTexDes.enableRandomWrite &#x3D; true;</span><br><span class="line">            reflectionTexDes.msaaSamples &#x3D; 1;</span><br><span class="line">            cmd.GetTemporaryRT(_reflectionTexID, reflectionTexDes);</span><br><span class="line"></span><br><span class="line">            var rtWidth &#x3D; reflectionTexDes.width;</span><br><span class="line">            var rtHeight &#x3D; reflectionTexDes.height;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; V矩阵</span><br><span class="line">            Matrix4x4 v &#x3D; renderingData.cameraData.camera.worldToCameraMatrix;</span><br><span class="line">            &#x2F;&#x2F; 还不清楚：为什么不直接使用renderingData.cameraData.GetProjectionMatrix()</span><br><span class="line">            Matrix4x4 p &#x3D; GL.GetGPUProjectionMatrix(renderingData.cameraData.GetProjectionMatrix(), false);</span><br><span class="line">            &#x2F;&#x2F; MVP矩阵变换过程都是 右乘向量，所以VP &#x3D; p * v;</span><br><span class="line">            var matrixVP &#x3D; p * v;</span><br><span class="line">            var invMatrixVP &#x3D; matrixVP.inverse;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; computeShader 中thread组设置为(8,8,1)</span><br><span class="line">            int threadGroupX &#x3D; reflectionTexDes.width &#x2F; 8;</span><br><span class="line">            int threadGroupY &#x3D; reflectionTexDes.height &#x2F; 8;</span><br><span class="line"></span><br><span class="line">            RenderTargetIdentifier cameraColorTex &#x3D; id;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; computeshader参数设置</span><br><span class="line">            cmd.SetComputeVectorParam(_computeShader, ShaderProperties.MainTexelSize, new Vector4(1.0f &#x2F; rtWidth, 1.0f &#x2F; rtHeight, rtWidth, rtHeight));</span><br><span class="line">            cmd.SetComputeVectorParam(_computeShader, ShaderProperties.PlanarPosition, planarDescriptor.position);</span><br><span class="line">            cmd.SetComputeVectorParam(_computeShader, ShaderProperties.PlanarNormal, planarDescriptor.normal);</span><br><span class="line">            cmd.SetComputeMatrixParam(_computeShader, ShaderProperties.MatrixVP, matrixVP);</span><br><span class="line">            cmd.SetComputeMatrixParam(_computeShader, ShaderProperties.MatrixInvVP, invMatrixVP);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Texture相关参数都只能对应kernel设置</span><br><span class="line">            cmd.SetComputeTextureParam(_computeShader, _kernelClear, ShaderProperties.Result, _reflectionTexID);</span><br><span class="line">            cmd.DispatchCompute(_computeShader, _kernelClear, threadGroupX, threadGroupY, 1);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Pass1 对像素做反转</span><br><span class="line">            cmd.SetComputeTextureParam(_computeShader, _kernalPass1, ShaderProperties.CameraColorTexture, cameraColorTex);</span><br><span class="line">            cmd.SetComputeTextureParam(_computeShader, _kernalPass1, ShaderProperties.Result, _reflectionTexID);</span><br><span class="line">            cmd.DispatchCompute(_computeShader, _kernalPass1, threadGroupX, threadGroupY, 1);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Pass2 修理反转后像素的遮挡问题</span><br><span class="line">            cmd.SetComputeTextureParam(_computeShader, _kernalPass2, ShaderProperties.CameraColorTexture, cameraColorTex);</span><br><span class="line">            cmd.SetComputeTextureParam(_computeShader, _kernalPass2, ShaderProperties.Result, _reflectionTexID);</span><br><span class="line">            cmd.DispatchCompute(_computeShader, _kernalPass2, threadGroupX, threadGroupY, 1);</span><br><span class="line"></span><br><span class="line">            if (_enableBlur)</span><br><span class="line">            &#123;</span><br><span class="line">                _blurBlitter.SetSource(_reflectionTexID, reflectionTexDes);</span><br><span class="line">                _blurBlitter.blurType &#x3D; BlurType.BoxBilinear;</span><br><span class="line">                _blurBlitter.iteratorCount &#x3D; 1;</span><br><span class="line">                _blurBlitter.downSample &#x3D; 1;</span><br><span class="line">                _blurBlitter.Render(cmd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 将结果图片设置为全局(在当前cmd内都能直接获取)</span><br><span class="line">            cmd.SetGlobalTexture(_reflectionTexID, _reflectionTexID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void ReleaseTemporary(CommandBuffer cmd)</span><br><span class="line">        &#123;</span><br><span class="line">            cmd.ReleaseTemporaryRT(_reflectionTexID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ReflectPlane：标记哪些平面需要反射</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">namespace URPLearn</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 一个平面，平面由一个点和法线来确定</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public struct PlanarDescriptor</span><br><span class="line">    &#123;</span><br><span class="line">        public Vector3 position;</span><br><span class="line">        public Vector3 normal;</span><br><span class="line"></span><br><span class="line">        public static bool operator &#x3D;&#x3D;(PlanarDescriptor p1, PlanarDescriptor p2)</span><br><span class="line">        &#123;</span><br><span class="line">            return IsNormalEqual(p1.normal, p2.normal) &amp;&amp; IsPositionInPlanar(p1.position, p2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static bool operator !&#x3D;(PlanarDescriptor p1, PlanarDescriptor p2)</span><br><span class="line">        &#123;</span><br><span class="line">            return !IsNormalEqual(p1.normal, p2.normal) || !IsPositionInPlanar(p1.position, p2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override bool Equals(object obj)</span><br><span class="line">        &#123;</span><br><span class="line">            if (obj &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            if (obj is PlanarDescriptor p)</span><br><span class="line">            &#123;</span><br><span class="line">                return IsNormalEqual(normal, p.normal) &amp;&amp; IsPositionInPlanar(p.position, this);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override int GetHashCode()</span><br><span class="line">        &#123;</span><br><span class="line">            int hash &#x3D; 17;</span><br><span class="line">            hash &#x3D; hash * 23 + position.GetHashCode();</span><br><span class="line">            hash &#x3D; hash * 23 + normal.GetHashCode();</span><br><span class="line">            return hash;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override string ToString()</span><br><span class="line">        &#123;</span><br><span class="line">            return base.ToString();</span><br><span class="line">        &#125;</span><br><span class="line">        private static bool IsNormalEqual(Vector3 n1, Vector3 n2)</span><br><span class="line">        &#123;</span><br><span class="line">            return 1 - Vector3.Dot(n1, n2) &lt; 0.001f;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static bool IsPositionInPlanar(Vector3 checkPos, PlanarDescriptor planar)</span><br><span class="line">        &#123;</span><br><span class="line">            return Vector3.Dot(planar.position - checkPos, planar.normal) &lt; 0.01f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class PlanarRendererGroup</span><br><span class="line">    &#123;</span><br><span class="line">        public PlanarDescriptor descriptor;</span><br><span class="line">        public HashSet&lt;Renderer&gt; renderers &#x3D; new HashSet&lt;Renderer&gt;();</span><br><span class="line"></span><br><span class="line">        public void Clear()</span><br><span class="line">        &#123;</span><br><span class="line">            renderers.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class PlanarRendererGroups</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 池子</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private Stack&lt;PlanarRendererGroup&gt; _freePool &#x3D; new Stack&lt;PlanarRendererGroup&gt;();</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 平面反射</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private List&lt;PlanarRendererGroup&gt; _planarRenderers &#x3D; new List&lt;PlanarRendererGroup&gt;();</span><br><span class="line"></span><br><span class="line">        public List&lt;PlanarRendererGroup&gt; PlanarRenderers &#x3D;&gt; _planarRenderers;</span><br><span class="line"></span><br><span class="line">        public void AddRender(Renderer renderer)</span><br><span class="line">        &#123;</span><br><span class="line">            var position &#x3D; renderer.transform.position;</span><br><span class="line">            var normal &#x3D; renderer.transform.up;</span><br><span class="line">            var planarDescriptor &#x3D; new PlanarDescriptor()</span><br><span class="line">            &#123;</span><br><span class="line">                position &#x3D; position,</span><br><span class="line">                normal &#x3D; normal</span><br><span class="line">            &#125;;</span><br><span class="line">            &#x2F;&#x2F; 如果有同一平面的则放在一起渲染</span><br><span class="line">            foreach (var renderers in _planarRenderers)</span><br><span class="line">            &#123;</span><br><span class="line">                if (renderers.descriptor &#x3D;&#x3D; planarDescriptor)</span><br><span class="line">                &#123;</span><br><span class="line">                    renderers.renderers.Add(renderer);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 没有则添加一个平面渲染组</span><br><span class="line">            &#123;</span><br><span class="line">                var group &#x3D; AllocateGroup();</span><br><span class="line">                group.descriptor &#x3D; planarDescriptor;</span><br><span class="line">                group.renderers.Add(renderer);</span><br><span class="line">                _planarRenderers.Add(group);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private PlanarRendererGroup AllocateGroup()</span><br><span class="line">        &#123;</span><br><span class="line">            if (_freePool.Count &gt; 0)</span><br><span class="line">                return _freePool.Pop();</span><br><span class="line">            else</span><br><span class="line">                return new PlanarRendererGroup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Clear()</span><br><span class="line">        &#123;</span><br><span class="line">            foreach (var group in _planarRenderers)</span><br><span class="line">            &#123;</span><br><span class="line">                group.Clear();</span><br><span class="line">                _freePool.Push(group);</span><br><span class="line">            &#125;</span><br><span class="line">            _planarRenderers.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ExecuteInEditMode]</span><br><span class="line">    public class ReflectPlane : MonoBehaviour</span><br><span class="line">    &#123;</span><br><span class="line">        private static List&lt;ReflectPlane&gt; _reflectPlanes &#x3D; new List&lt;ReflectPlane&gt;();</span><br><span class="line">        public static List&lt;ReflectPlane&gt; ReflectPlanes &#x3D;&gt; _reflectPlanes;</span><br><span class="line"></span><br><span class="line">        public static void GetVisiblePlanarGroups(PlanarRendererGroups groups)</span><br><span class="line">        &#123;</span><br><span class="line">            groups.Clear();</span><br><span class="line">            foreach (var p in ReflectPlanes)</span><br><span class="line">            &#123;</span><br><span class="line">                var renderer &#x3D; p.GetComponent&lt;Renderer&gt;();</span><br><span class="line">                if (renderer.isVisible)</span><br><span class="line">                &#123;</span><br><span class="line">                    groups.AddRender(renderer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private void OnEnable()</span><br><span class="line">        &#123;</span><br><span class="line">            _reflectPlanes.Add(this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private void OnDisable()</span><br><span class="line">        &#123;</span><br><span class="line">            _reflectPlanes.Remove(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ComputeShader：对图像进行反转操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">#pragma kernel Clear</span><br><span class="line">#pragma kernel DrawReflectionTex1</span><br><span class="line">#pragma kernel DrawReflectionTex2</span><br><span class="line">#pragma kernel DrawReflectionTex1 EXCLUDE_BACKGROUND</span><br><span class="line">#pragma kernel DrawReflectionTex2 EXCLUDE_BACKGROUND</span><br><span class="line"></span><br><span class="line">#include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line"></span><br><span class="line">RWTexture2D&lt;float4&gt; _Result;</span><br><span class="line"></span><br><span class="line">Texture2D&lt;float4&gt; _CameraColorTexture;</span><br><span class="line">Texture2D&lt;float&gt; _CameraDepthTexture;</span><br><span class="line">float4 _MainTex_TexelSize;</span><br><span class="line"></span><br><span class="line">float4x4 _MatrixInvVP;</span><br><span class="line">float4x4 _MatrixVP;</span><br><span class="line"></span><br><span class="line">float3 _PlanarPosition;</span><br><span class="line">float3 _PlanarNormal;</span><br><span class="line"></span><br><span class="line">SamplerState PointClampSampler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">float3 TransformPositionCSToWS(float3 positionCS) &#123;</span><br><span class="line">    float4 positionWS &#x3D; mul(_MatrixInvVP, float4(positionCS, 1));</span><br><span class="line">    positionWS &#x2F;&#x3D; positionWS.w;</span><br><span class="line">    return positionWS.xyz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 ReconstructPositionWS(float2 uv, float depth) &#123;</span><br><span class="line">    float3 positionCS &#x3D; float3(uv * 2 - 1, depth);</span><br><span class="line">    float3 positionWS &#x3D; TransformPositionCSToWS(positionCS);</span><br><span class="line">    return positionWS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 Reproject(float3 positionWS) &#123;</span><br><span class="line">    float4 positionCS &#x3D; mul(_MatrixVP, float4(positionWS, 1));</span><br><span class="line">    positionCS &#x2F;&#x3D; positionCS.w;</span><br><span class="line">    positionCS.xy &#x3D; (positionCS.xy + 1) * 0.5;</span><br><span class="line">    return positionCS.xyz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 GetMirrorPositionWS(float3 positionWS) &#123;</span><br><span class="line">    float normalProj &#x3D; dot(positionWS - _PlanarPosition, _PlanarNormal);</span><br><span class="line">    return float4(positionWS - normalProj * _PlanarNormal * 2, normalProj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[numthreads(8, 8, 1)]</span><br><span class="line">void Clear(uint3 id : SV_DispatchThreadID)</span><br><span class="line">&#123;</span><br><span class="line">    _Result[id.xy] &#x3D; float4(0, 0, 0, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">float4 GetMirrorPositionWSFromID(uint3 id) &#123;</span><br><span class="line">    float2 pixelCoord &#x3D; id.xy;</span><br><span class="line">    float2 uv &#x3D; id.xy * _MainTex_TexelSize.xy;</span><br><span class="line">    float depth &#x3D; _CameraDepthTexture.SampleLevel(PointClampSampler, uv, 0);</span><br><span class="line">#ifdef EXCLUDE_BACKGROUND</span><br><span class="line">#if UNITY_REVERSED_Z</span><br><span class="line">    if (depth &#x3D;&#x3D; 0)</span><br><span class="line">#else</span><br><span class="line">    if (depth &#x3D;&#x3D; 1)</span><br><span class="line">#endif</span><br><span class="line">    &#123;</span><br><span class="line">        return float4(0, 0, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    float3 positionWS &#x3D; ReconstructPositionWS(uv, depth);</span><br><span class="line">    float4 mirrorPositionWS &#x3D; GetMirrorPositionWS(positionWS);</span><br><span class="line">    return mirrorPositionWS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 GetMirrorUVDepthFromID(uint3 id) &#123;</span><br><span class="line">    float4 mirrorPositionWS &#x3D; GetMirrorPositionWSFromID(id);</span><br><span class="line">    if (mirrorPositionWS.w &gt; 0.01) &#123;</span><br><span class="line">        float3 uvAndDepth &#x3D; Reproject(mirrorPositionWS.xyz);</span><br><span class="line">        return uvAndDepth;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return float3(0, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[numthreads(8, 8, 1)]</span><br><span class="line">void DrawReflectionTex1(uint3 id : SV_DispatchThreadID) &#123;</span><br><span class="line">    float2 uv &#x3D; id.xy;</span><br><span class="line">    float3 mirrorUVAndDepth &#x3D; GetMirrorUVDepthFromID(id);</span><br><span class="line">    float2 mirrorPixelCoord &#x3D; mirrorUVAndDepth.xy * _MainTex_TexelSize.zw;</span><br><span class="line">    _Result[mirrorPixelCoord] &#x3D; float4(_CameraColorTexture[uv].rgb, mirrorUVAndDepth.z);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[numthreads(8, 8, 1)]</span><br><span class="line">void DrawReflectionTex2(uint3 id : SV_DispatchThreadID) &#123;</span><br><span class="line">    float2 uv &#x3D; id.xy;</span><br><span class="line">    float3 mirrorUVAndDepth &#x3D; GetMirrorUVDepthFromID(id);</span><br><span class="line">    float2 toPixelCoord &#x3D; mirrorUVAndDepth.xy * _MainTex_TexelSize.zw;</span><br><span class="line">    float4 originalColor &#x3D; _Result[toPixelCoord];</span><br><span class="line"></span><br><span class="line">#if UNITY_REVERSED_Z</span><br><span class="line">    bool overwrite &#x3D; mirrorUVAndDepth.z &gt; originalColor.a;</span><br><span class="line">#else</span><br><span class="line">    bool overwrite &#x3D; mirrorUVAndDepth.z &lt; originalColor.a;</span><br><span class="line">#endif</span><br><span class="line">    if (overwrite) &#123;</span><br><span class="line">        _Result[toPixelCoord] &#x3D; float4(_CameraColorTexture[uv].rgb, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        _Result[toPixelCoord] &#x3D; float4(originalColor.rgb, 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结-16"><a href="#总结-16" class="headerlink" title="总结"></a>总结</h2><ul>
<li>ComputeScreenPos在顶点着色器计算好屏幕空间坐标，再在片元着色器做齐次除法就可以得到屏幕uv</li>
<li>屏幕空间操作指南：参考上面SSAO总结，一般就是涉及世界坐标重建这个事情</li>
</ul>
<h1 id="URP实现PBR"><a href="#URP实现PBR" class="headerlink" title="URP实现PBR"></a>URP实现PBR</h1><h2 id="基础-12"><a href="#基础-12" class="headerlink" title="基础"></a>基础</h2><ul>
<li>满足以下几点的光照模型，符合PBR模型：</li>
</ul>
<ol>
<li>微表面：不同材质的平面，有很多不同朝向不一的微小平面</li>
<li>能量守恒：出射光的总量不超过入射光的总量</li>
<li>反射方程：使用基于物理的BRDF(双向反射分布函数)</li>
</ol>
<ul>
<li><p>PBR反射方程：L(o) = f(fr(p,wi,wo) * Li(p,wi) * dot(n,wi) * dwi)</p>
</li>
<li><p>BRDF-Cooktorrance方程：</p>
</li>
</ul>
<ol>
<li>fr(p,wi,wo) = k(d)*f(lambert) + K(s)*f(cook-torrance)</li>
<li>f(lamber) = c / Π</li>
<li>∫(cook-torrance) = D<em>F</em>G / (4*dot(wo,n)*dot(wi,n))</li>
<li>D：法线分布函数（NDF），估算微平面的整体取向，公式：a^2 / (Π * (NdotH^2) * (a^2-1) + 1)^2  （注：a表示粗糙度）</li>
<li>F: 菲尼尔方程，用于描述表面反射光所占比例， 公式： F0 + (1 - F0) * pos(1 - cosTheta, 5) （注：F0表示不同材质的垂直方向的反射率，直接光照中cosTheta：HdotV或HdotL，间接光照中cosTheta：NdotV）</li>
<li>G：几何函数，用于计算微表面，自阴影， 公式：cosTheta / (cosTheta(1.0 - k) + k)  （注：k由粗糙度a计算，直接光照：k=(a+1)^2 / 8， 间接光照：k=a^2 / 2 ， cosTheta需要分别计算NoV,NoL的和）</li>
<li>K(d)：(1-F)*(1-metallic)</li>
<li>K(s)：菲尼尔值里包括了表面反射系数，因此K(s)不需要</li>
</ol>
<ul>
<li>IBL间接光照</li>
</ul>
<ol>
<li>CubeMap IrradianceMap 或者ShadeSH9() ,URP用SampleSH9() 球谐函数计算间接光照的diffuse</li>
<li>预高光积分图，或者高光积分算法计算间接光照的specular<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/%E9%A2%84%E9%AB%98%E5%85%89%E7%A7%AF%E5%88%86%E5%9B%BE.png" alt="预高光积分图" title="预高光积分图"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">float2 IntegrateSpecularBRDF(float NoV, float roughness)</span><br><span class="line">&#123;</span><br><span class="line">    const float4 c0 &#x3D; float4(-1, -0.0275, -0.572, 0.022);</span><br><span class="line">    const float4 c1 &#x3D; float4(1, 0.0425, 1.04, -0.04);</span><br><span class="line">    float4 r &#x3D; roughness * c0 + c1;</span><br><span class="line">    float a004 &#x3D; min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;</span><br><span class="line">    return float2(-c1.z, c1.z) * a004 + r.zw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>准备资源<br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/PBR%E5%9F%BA%E7%A1%80%E9%A2%9C%E8%89%B2.png" alt="PBR基础颜色" title="PBR基础颜色"><br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/PBR%E6%B3%95%E7%BA%BF.png" alt="PBR法线" title="PBR法线"><br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/PBR%E9%87%91%E5%B1%9E%E5%BA%A6.png" alt="PBR金属度" title="PBR金属度"><br><img src="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/PBR%E7%B2%97%E7%B3%99%E5%BA%A6.png" alt="PBR粗糙度" title="PBR粗糙度"></li>
</ul>
<h2 id="代码-18"><a href="#代码-18" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Unlit&#x2F;PBR&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _BaseColor(&quot;_BaseColor&quot;, Color) &#x3D; (1, 1, 1, 1)</span><br><span class="line">        _MainTex(&quot;_MainTex&quot;, 2D) &#x3D; &quot;white&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">        _BumpScale(&quot;_BumpScale&quot;, Range(-1, 1)) &#x3D; 1</span><br><span class="line">        [NoScaleOffset] _BumpMap(&quot;_BumpMap&quot;, 2D) &#x3D; &quot;bump&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">        [NoScaleOffset] _MetalnessMap(&quot;_MetalnessMap&quot;, 2D) &#x3D; &quot;black&quot; &#123;&#125;</span><br><span class="line">        [NoScaleOffset] _RoughnessMap(&quot;_RoughnessMap&quot;, 2D) &#x3D; &quot;gray&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">        _IndirectIntensity(&quot;_IndirectIntensity&quot;, Range(0, 1)) &#x3D; 1</span><br><span class="line">        &#x2F;&#x2F;[NoScaleOffset] _IrradianceCube (&quot;_IrradianceCube&quot;, Cube) &#x3D; &quot;black&quot; &#123;&#125;</span><br><span class="line">        &#x2F;&#x2F;[NoScaleOffset] _RadianceCube (&quot;_RadianceCube&quot;, Cube) &#x3D; &quot;black&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">        [Toggle(USE_BRDF_INTEGRATION_MAP)] _UseBRDFIntegrationMap(&quot;_UseBRDFIntegrationMap&quot;, Float) &#x3D; 0</span><br><span class="line">        [NoScaleOffset] _BRDFIntegrationMap(&quot;_BRDFIntegrationMap&quot;, 2D) &#x3D; &quot;black&quot; &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot; &#x3D; &quot;Opaque&quot; &quot;RenderPipeline&quot; &#x3D; &quot;UniversalPipeline&quot;&#125;</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line">        #define EPSILSON 0.000001</span><br><span class="line">        #define BRDF_PI 3.14159265359</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;</span><br><span class="line">        #include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MainTex);</span><br><span class="line">        SAMPLER(sampler_MainTex);</span><br><span class="line">        TEXTURE2D(_BumpMap);</span><br><span class="line">        SAMPLER(sampler_BumpMap);</span><br><span class="line"></span><br><span class="line">        TEXTURE2D(_MetalnessMap);</span><br><span class="line">        SAMPLER(sampler_MetalnessMap);</span><br><span class="line">        TEXTURE2D(_RoughnessMap);</span><br><span class="line">        SAMPLER(sampler_RoughnessMap);</span><br><span class="line">        TEXTURE2D(_BRDFIntegrationMap);</span><br><span class="line">        SAMPLER(sampler_BRDFIntegrationMap);</span><br><span class="line"></span><br><span class="line">        CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        float4 _MainTex_ST;</span><br><span class="line">        float4 _BaseColor;</span><br><span class="line">        float _BumpScale;</span><br><span class="line">        float _IndirectIntensity;</span><br><span class="line">        CBUFFER_END</span><br><span class="line"></span><br><span class="line">        struct Attributes</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionOS:POSITION;</span><br><span class="line">            float4 normalOS:NORMAL;</span><br><span class="line">            float4 tangentOS:TANGENT;</span><br><span class="line">            float2 uv           : TEXCOORD0;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        struct Varyings</span><br><span class="line">        &#123;</span><br><span class="line">            float4 positionHS    : SV_POSITION;</span><br><span class="line">            float2 uv            : TEXCOORD0;</span><br><span class="line">            float4 tangentWS:TEXCOORD1;</span><br><span class="line">            float4 BtangentWS:TEXCOORD2;</span><br><span class="line">            float4 normalWS:TEXCOORD3;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;菲涅尔函数</span><br><span class="line">        float3 FresnelSchlick(float NoV, float3 F0)</span><br><span class="line">        &#123;</span><br><span class="line">            return F0 + (1.0 - F0) * pow(1.0 - NoV, 5);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;几何函数</span><br><span class="line">        float GeometrySchlickGGX(float NoV, float k)</span><br><span class="line">        &#123;</span><br><span class="line">            return NoV &#x2F; max(NoV * (1.0 - k) + k, EPSILSON);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;几何函数</span><br><span class="line">        float GeometrySmith(float NoV, float NoL, float k)</span><br><span class="line">        &#123;</span><br><span class="line">            return GeometrySchlickGGX(NoV, k) * GeometrySchlickGGX(NoL, k);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;分布函数 alpha&#x3D;roughness*roughness</span><br><span class="line">        float DistributionGGX(float NoH, float alpha)</span><br><span class="line">        &#123;</span><br><span class="line">            float a2 &#x3D; alpha * alpha;</span><br><span class="line">            float denom &#x3D; pow(NoH * NoH * (a2 - 1.0) + 1.0, 2);</span><br><span class="line">            return a2 &#x2F; max(denom * BRDF_PI, EPSILSON);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;计算直接光照</span><br><span class="line">        float3 CalcDirectLight(float metalness, float roughness, float3 albedo, float3 F0, float3 normal, float3 viewDir, float NoV, float3 worldPos)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;准备参数</span><br><span class="line">            Light mylight &#x3D; GetMainLight();</span><br><span class="line">            float3 lightDir &#x3D; normalize(mylight.direction); &#x2F;&#x2F;获取光线方向</span><br><span class="line">            float3 floatDir &#x3D; normalize(viewDir + lightDir); &#x2F;&#x2F;计算半角方向</span><br><span class="line">            float NoL &#x3D; saturate(dot(normal, lightDir)); &#x2F;&#x2F;计算法线光线点积</span><br><span class="line">            float NoH &#x3D; saturate(dot(normal, floatDir)); &#x2F;&#x2F;计算法线半角点积</span><br><span class="line">            float HoL &#x3D; saturate(dot(floatDir, lightDir)); &#x2F;&#x2F;计算半角光线点积，同半角视线点积</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;计算方程参数</span><br><span class="line">            float3 F &#x3D; FresnelSchlick(HoL, F0); &#x2F;&#x2F;计算菲涅尔</span><br><span class="line">            float G &#x3D; GeometrySmith(NoV, NoL, pow(roughness + 1.0, 2) &#x2F; 8.0); &#x2F;&#x2F;计算遮挡</span><br><span class="line">            float D &#x3D; DistributionGGX(NoH, roughness * roughness); &#x2F;&#x2F;计算分布</span><br><span class="line">            float3 kD &#x3D; (1.0 - F) * (1.0 - metalness); &#x2F;&#x2F;计算漫反射系数</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;计算直接光照结果</span><br><span class="line">            float3 directDiffuse &#x3D; kD * albedo &#x2F; BRDF_PI; &#x2F;&#x2F;计算漫反射</span><br><span class="line">            float3 directSpecular &#x3D; F * (D * G) &#x2F; (4.0 * max(NoV * NoL, EPSILSON)); &#x2F;&#x2F;计算高光</span><br><span class="line">            float3 directLightIn &#x3D; mylight.color * BRDF_PI; &#x2F;&#x2F;获取直接光照颜色</span><br><span class="line">            return (directDiffuse + directSpecular) * NoL * directLightIn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        float2 IntegrateSpecularBRDF(float NoV, float roughness)</span><br><span class="line">        &#123;</span><br><span class="line">            const float4 c0 &#x3D; float4(-1, -0.0275, -0.572, 0.022);</span><br><span class="line">            const float4 c1 &#x3D; float4(1, 0.0425, 1.04, -0.04);</span><br><span class="line">            float4 r &#x3D; roughness * c0 + c1;</span><br><span class="line">            float a004 &#x3D; min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;</span><br><span class="line">            return float2(-c1.z, c1.z) * a004 + r.zw;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        real3 SampleSH(real3 normalWS)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; LPPV is not supported in Ligthweight Pipeline</span><br><span class="line">            real4 SHCoefficients[7];</span><br><span class="line">            SHCoefficients[0] &#x3D; unity_SHAr;</span><br><span class="line">            SHCoefficients[1] &#x3D; unity_SHAg;</span><br><span class="line">            SHCoefficients[2] &#x3D; unity_SHAb;</span><br><span class="line">            SHCoefficients[3] &#x3D; unity_SHBr;</span><br><span class="line">            SHCoefficients[4] &#x3D; unity_SHBg;</span><br><span class="line">            SHCoefficients[5] &#x3D; unity_SHBb;</span><br><span class="line">            SHCoefficients[6] &#x3D; unity_SHC;</span><br><span class="line"></span><br><span class="line">            return max(real3(0, 0, 0), SampleSH9(SHCoefficients, normalWS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;计算间接光照</span><br><span class="line">        float3 CalcIndirectLight(float metalness, float roughness, float3 albedo, float3 F0, float3 normal, float3 viewDir, float NoV)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;准备参数</span><br><span class="line">            float3 F &#x3D; FresnelSchlick(NoV, F0); &#x2F;&#x2F;计算菲涅尔</span><br><span class="line">            float3 kD &#x3D; (1.0 - F) * (1.0 - metalness); &#x2F;&#x2F;计算漫反射系数</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;计算间接漫反射</span><br><span class="line">            &#x2F;&#x2F;float3 indirectDiffuse &#x3D; SAMPLE_TEXTURE2D(_IrradianceCube, normal).rgb;</span><br><span class="line">            float3 indirectDiffuse &#x3D; SampleSH(normal);</span><br><span class="line">            indirectDiffuse *&#x3D; kD * albedo;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;计算间接高光</span><br><span class="line">            float mip &#x3D; PerceptualRoughnessToMipmapLevel(roughness); &#x2F;&#x2F;计算粗糙度对应MIP</span><br><span class="line">            float3 reflDir &#x3D; reflect(-viewDir, normal); &#x2F;&#x2F;计算视线反射方向</span><br><span class="line">            &#x2F;&#x2F;float3 indirectSpecular &#x3D; SAMPLE_TEXTURECUBE_LOD(_RadianceCube, float4(reflDir, mip)).rgb;</span><br><span class="line">            float4 encodedIrradiance &#x3D; SAMPLE_TEXTURECUBE_LOD(unity_SpecCube0, samplerunity_SpecCube0, reflDir, mip);</span><br><span class="line">            float3 indirectSpecular &#x3D; DecodeHDREnvironment(encodedIrradiance, unity_SpecCube0_HDR);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;高光积分</span><br><span class="line">#if USE_BRDF_INTEGRATION_MAP</span><br><span class="line">            float2 envBRDF &#x3D; SAMPLE_TEXTURE2D(_BRDFIntegrationMap, sampler_BRDFIntegrationMap, float2(NoV, roughness)).rg;</span><br><span class="line">#else</span><br><span class="line">            float2 envBRDF &#x3D; IntegrateSpecularBRDF(NoV, roughness);</span><br><span class="line">#endif</span><br><span class="line">            indirectSpecular *&#x3D; F * envBRDF.x + envBRDF.y;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;计算间接光照结果</span><br><span class="line">            return (indirectDiffuse + indirectSpecular) * _IndirectIntensity;</span><br><span class="line">        &#125;</span><br><span class="line">        ENDHLSL</span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags&#123; &quot;LightMode&quot; &#x3D; &quot;UniversalForward&quot; &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex Vert</span><br><span class="line">            #pragma fragment Frag</span><br><span class="line">            #pragma shader_feature USE_BRDF_INTEGRATION_MAP</span><br><span class="line"></span><br><span class="line">            Varyings Vert(Attributes i)</span><br><span class="line">            &#123;</span><br><span class="line">                Varyings o;</span><br><span class="line">                VertexPositionInputs input &#x3D; GetVertexPositionInputs(i.positionOS.xyz);</span><br><span class="line">                o.positionHS &#x3D; input.positionCS;</span><br><span class="line"></span><br><span class="line">                VertexNormalInputs normalInput &#x3D; GetVertexNormalInputs(i.normalOS, i.tangentOS);</span><br><span class="line">                o.tangentWS.xyz &#x3D; normalInput.tangentWS;</span><br><span class="line">                o.BtangentWS.xyz &#x3D; normalInput.bitangentWS;</span><br><span class="line">                o.normalWS.xyz &#x3D; normalInput.normalWS;</span><br><span class="line">                &#x2F;&#x2F; 存一下世界空间坐标</span><br><span class="line">                o.tangentWS.w &#x3D; input.positionWS.x;</span><br><span class="line">                o.BtangentWS.w &#x3D; input.positionWS.y;</span><br><span class="line">                o.normalWS.w &#x3D; input.positionWS.z;</span><br><span class="line"></span><br><span class="line">                o.uv &#x3D; TRANSFORM_TEX(i.uv, _MainTex);</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            float4 Frag(Varyings i) :SV_Target&#123;</span><br><span class="line"></span><br><span class="line">                float3 positionWS &#x3D; float3(i.tangentWS.w,i.BtangentWS.w,i.normalWS.w);</span><br><span class="line"></span><br><span class="line">                float metalness &#x3D; SAMPLE_TEXTURE2D(_MetalnessMap, sampler_MetalnessMap, i.uv).r;</span><br><span class="line">                float roughness &#x3D; SAMPLE_TEXTURE2D(_RoughnessMap, sampler_RoughnessMap, i.uv).r;</span><br><span class="line">                float4 mainColor &#x3D; SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">                float3 albedo &#x3D; _BaseColor.rgb * mainColor.rgb;</span><br><span class="line"></span><br><span class="line">                float3x3 T2W &#x3D; &#123; i.tangentWS.xyz, i.BtangentWS.xyz, i.normalWS.xyz &#125;;</span><br><span class="line"></span><br><span class="line">                float4 norTex &#x3D; SAMPLE_TEXTURE2D(_BumpMap, sampler_BumpMap, i.uv);</span><br><span class="line">                float3 normalTS &#x3D; UnpackNormalScale(norTex, _BumpScale);</span><br><span class="line">                normalTS.z &#x3D; pow(1 - pow(normalTS.x, 2) - pow(normalTS.y, 2), 0.5f);    &#x2F;&#x2F;规范化</span><br><span class="line">                float3 normalWS &#x3D; normalize(mul(normalTS, T2W));</span><br><span class="line">                float3 viewDirWS &#x3D; normalize(_WorldSpaceCameraPos.xyz - positionWS);</span><br><span class="line"></span><br><span class="line">                float3 F0 &#x3D; lerp(0.04f, albedo, metalness);</span><br><span class="line">                float NoV &#x3D; dot(normalWS, viewDirWS);</span><br><span class="line"></span><br><span class="line">                float3 directColor &#x3D; CalcDirectLight(metalness, roughness, albedo, F0, normalWS, viewDirWS, NoV, positionWS);</span><br><span class="line">                float3 indirectColor &#x3D; CalcIndirectLight(metalness, roughness, albedo, F0, normalWS, viewDirWS, NoV);</span><br><span class="line"></span><br><span class="line">                return float4(directColor + indirectColor, mainColor.a);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结-17"><a href="#总结-17" class="headerlink" title="总结"></a>总结</h2><h1 id="草绘制"><a href="#草绘制" class="headerlink" title="草绘制"></a>草绘制</h1><h2 id="基础-13"><a href="#基础-13" class="headerlink" title="基础"></a>基础</h2><h2 id="代码-19"><a href="#代码-19" class="headerlink" title="代码"></a>代码</h2><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><h2 id="总结-18"><a href="#总结-18" class="headerlink" title="总结"></a>总结</h2><h1 id="浅水"><a href="#浅水" class="headerlink" title="浅水"></a>浅水</h1><h2 id="基础-14"><a href="#基础-14" class="headerlink" title="基础"></a>基础</h2><h2 id="代码-20"><a href="#代码-20" class="headerlink" title="代码"></a>代码</h2><h2 id="效果展示-1"><a href="#效果展示-1" class="headerlink" title="效果展示"></a>效果展示</h2><h2 id="总结-19"><a href="#总结-19" class="headerlink" title="总结"></a>总结</h2><h1 id><a href="#" class="headerlink" title></a></h1><h1 id="链接-2"><a href="#链接-2" class="headerlink" title="链接"></a>链接</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/marsz1990/article/details/106110120/">Unity3D游戏开发中100+效果的实现和源码大全 - 收藏起来肯定用得着</a><br><a target="_blank" rel="noopener" href="https://space.bilibili.com/5863867/article">URP HLSL入门学习</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/poem_qianmo/article/details/105350519">高品质后处理：十种图像模糊算法的总结与实现</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Skier</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://skierhou.github.io/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/">https://skierhou.github.io/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://SkierHou.github.io" target="_blank">Skier</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/Graphics/">Graphics</a><a class="post-meta__tags" href="/blog/tags/URP/">URP</a></div><div class="post_share"><div class="social-share" data-image="/blog/img/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/2021/12/01/CSharp/Thread/"><img class="prev-cover" src="/blog/img/1.png" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">C# Thread记录</div></div></a></div><div class="next-post pull-right"><a href="/blog/2021/11/21/Graphics/URP/URP%E5%AD%A6%E4%B9%A0%E6%B1%87%E6%80%BB/"><img class="next-cover" src="/blog/img/1.png" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">URP学习汇总</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blog/2021/03/12/Graphics/3D Math Primer for Graphics and Game 2nd/" title="3D数学基础：图形与游戏开发"><img class="cover" src="/blog/img/1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-12</div><div class="title">3D数学基础：图形与游戏开发</div></div></a></div><div><a href="/blog/2021/03/31/Graphics/OpenGL/" title="OpenGL学习"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-31</div><div class="title">OpenGL学习</div></div></a></div><div><a href="/blog/2021/03/31/Graphics/UnityShader/" title="UnityShader基础渲染知识点概况"><img class="cover" src="/blog/img/1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-31</div><div class="title">UnityShader基础渲染知识点概况</div></div></a></div><div><a href="/blog/2021/03/31/Graphics/Games101作业/" title="Games101作业"><img class="cover" src="/blog/img/1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-31</div><div class="title">Games101作业</div></div></a></div><div><a href="/blog/2021/03/31/Graphics/Games101学习笔记/" title="Games101学习笔记"><img class="cover" src="/blog/img/1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-31</div><div class="title">Games101学习笔记</div></div></a></div><div><a href="/blog/2021/08/23/Graphics/Unity大世界模块记录/" title="Unity大世界模块记录"><img class="cover" src="/blog/img/1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-23</div><div class="title">Unity大世界模块记录</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/blog/img/head.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Skier</div><div class="author-info__description">游戏开发</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div><div class="card-info-data-item is-center"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/SkierHou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/SkierHou" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:675363508@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">基础光照模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%85%AC%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">基础公式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%95%E7%BA%BF%E8%B4%B4%E5%9B%BE"><span class="toc-number">3.</span> <span class="toc-text">法线贴图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">基础简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">3.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B8%90%E5%8F%98%E7%BA%B9%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">渐变纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%80%9D%E8%B7%AF"><span class="toc-number">4.1.</span> <span class="toc-text">基础思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="toc-number">4.2.</span> <span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlphaTest"><span class="toc-number">5.</span> <span class="toc-text">AlphaTest</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%AE%80%E4%BB%8B-1"><span class="toc-number">5.1.</span> <span class="toc-text">基础简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-3"><span class="toc-number">5.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">5.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlphaBlend"><span class="toc-number">6.</span> <span class="toc-text">AlphaBlend</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%AE%80%E4%BB%8B-2"><span class="toc-number">6.1.</span> <span class="toc-text">基础简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-4"><span class="toc-number">6.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">6.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E5%85%89%E6%BA%90"><span class="toc-number">7.</span> <span class="toc-text">多光源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">7.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-5"><span class="toc-number">7.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">7.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B4%E5%BD%B1%E6%8A%95%E5%B0%84%E5%92%8C%E6%8E%A5%E6%94%B6"><span class="toc-number">8.</span> <span class="toc-text">阴影投射和接收</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-1"><span class="toc-number">8.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-6"><span class="toc-number">8.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-5"><span class="toc-number">8.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%B8%A7"><span class="toc-number">9.</span> <span class="toc-text">序列帧</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-2"><span class="toc-number">9.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-7"><span class="toc-number">9.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-6"><span class="toc-number">9.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%BF%E5%91%8A%E7%89%8C"><span class="toc-number">10.</span> <span class="toc-text">广告牌</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-3"><span class="toc-number">10.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-8"><span class="toc-number">10.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-7"><span class="toc-number">10.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%BB%E7%92%83%E6%95%88%E6%9E%9C"><span class="toc-number">11.</span> <span class="toc-text">玻璃效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-4"><span class="toc-number">11.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-9"><span class="toc-number">11.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-8"><span class="toc-number">11.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E6%B7%B1%E5%BA%A6%EF%BC%8C%E6%8A%A4%E7%9B%BE%E7%89%B9%E6%95%88"><span class="toc-number">12.</span> <span class="toc-text">屏幕深度，护盾特效</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-5"><span class="toc-number">12.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-10"><span class="toc-number">12.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-9"><span class="toc-number">12.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%89%B9%E5%AE%9A%E7%89%A9%E4%BD%93%E6%8F%8F%E8%BE%B9%E6%95%88%E6%9E%9C"><span class="toc-number">13.</span> <span class="toc-text">特定物体描边效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-number">13.1.</span> <span class="toc-text">链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-6"><span class="toc-number">13.2.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-11"><span class="toc-number">13.3.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-10"><span class="toc-number">13.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B%E6%8F%8F%E8%BE%B9"><span class="toc-number">14.</span> <span class="toc-text">边缘检测描边</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-7"><span class="toc-number">14.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-12"><span class="toc-number">14.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-11"><span class="toc-number">14.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%91%E5%B9%BB%E6%89%AB%E6%8F%8F%E6%95%88%E6%9E%9C"><span class="toc-number">15.</span> <span class="toc-text">科幻扫描效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5-1"><span class="toc-number">15.1.</span> <span class="toc-text">链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-8"><span class="toc-number">15.2.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-13"><span class="toc-number">15.3.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-12"><span class="toc-number">15.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E7%82%AB%E5%85%89%EF%BC%8C%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%B9%BF%E5%91%8A%E7%89%8C%E7%AE%97%E6%B3%95"><span class="toc-number">16.</span> <span class="toc-text">屏幕炫光，更好的广告牌算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-9"><span class="toc-number">16.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-14"><span class="toc-number">16.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-13"><span class="toc-number">16.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4%E8%B4%B4%E8%8A%B1"><span class="toc-number">17.</span> <span class="toc-text">屏幕空间贴花</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-10"><span class="toc-number">17.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-15"><span class="toc-number">17.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-14"><span class="toc-number">17.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSAO%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4%E7%8E%AF%E5%A2%83%E5%85%89%E9%81%AE%E8%94%BD"><span class="toc-number">18.</span> <span class="toc-text">SSAO屏幕空间环境光遮蔽</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><span class="toc-number">18.1.</span> <span class="toc-text">基础理论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-16"><span class="toc-number">18.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-15"><span class="toc-number">18.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSPR%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4%E5%B9%B3%E9%9D%A2%E5%8F%8D%E5%B0%84"><span class="toc-number">19.</span> <span class="toc-text">SSPR屏幕空间平面反射</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-11"><span class="toc-number">19.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-17"><span class="toc-number">19.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-16"><span class="toc-number">19.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#URP%E5%AE%9E%E7%8E%B0PBR"><span class="toc-number">20.</span> <span class="toc-text">URP实现PBR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-12"><span class="toc-number">20.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-18"><span class="toc-number">20.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-17"><span class="toc-number">20.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8D%89%E7%BB%98%E5%88%B6"><span class="toc-number">21.</span> <span class="toc-text">草绘制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-13"><span class="toc-number">21.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-19"><span class="toc-number">21.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">21.3.</span> <span class="toc-text">效果展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-18"><span class="toc-number">21.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%85%E6%B0%B4"><span class="toc-number">22.</span> <span class="toc-text">浅水</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-14"><span class="toc-number">22.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-20"><span class="toc-number">22.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-1"><span class="toc-number">22.3.</span> <span class="toc-text">效果展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-19"><span class="toc-number">22.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">23.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5-2"><span class="toc-number">24.</span> <span class="toc-text">链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/12/20/Unity/%E4%B8%80%E4%BA%9B%E8%AE%B0%E5%BD%95/" title="Unity 开发一些记录"><img src="/blog/img/1.png" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Unity 开发一些记录"/></a><div class="content"><a class="title" href="/blog/2021/12/20/Unity/%E4%B8%80%E4%BA%9B%E8%AE%B0%E5%BD%95/" title="Unity 开发一些记录">Unity 开发一些记录</a><time datetime="2021-12-20T06:30:01.000Z" title="发表于 2021-12-20 14:30:01">2021-12-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/12/01/CSharp/Task/" title="C# Task用法记录"><img src="/blog/img/1.png" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="C# Task用法记录"/></a><div class="content"><a class="title" href="/blog/2021/12/01/CSharp/Task/" title="C# Task用法记录">C# Task用法记录</a><time datetime="2021-12-01T06:30:01.000Z" title="发表于 2021-12-01 14:30:01">2021-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/12/01/CSharp/Thread/" title="C# Thread记录"><img src="/blog/img/1.png" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="C# Thread记录"/></a><div class="content"><a class="title" href="/blog/2021/12/01/CSharp/Thread/" title="C# Thread记录">C# Thread记录</a><time datetime="2021-12-01T06:30:01.000Z" title="发表于 2021-12-01 14:30:01">2021-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/" title="URP效果实现,从基础慢慢深入"><img src="/blog/img/1.png" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="URP效果实现,从基础慢慢深入"/></a><div class="content"><a class="title" href="/blog/2021/11/30/Graphics/URP/URP%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0/" title="URP效果实现,从基础慢慢深入">URP效果实现,从基础慢慢深入</a><time datetime="2021-11-30T06:30:01.000Z" title="发表于 2021-11-30 14:30:01">2021-11-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/11/21/Graphics/URP/URP%E5%AD%A6%E4%B9%A0%E6%B1%87%E6%80%BB/" title="URP学习汇总"><img src="/blog/img/1.png" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="URP学习汇总"/></a><div class="content"><a class="title" href="/blog/2021/11/21/Graphics/URP/URP%E5%AD%A6%E4%B9%A0%E6%B1%87%E6%80%BB/" title="URP学习汇总">URP学习汇总</a><time datetime="2021-11-21T06:30:01.000Z" title="发表于 2021-11-21 14:30:01">2021-11-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Skier</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><div class="js-pjax"></div><script defer data-pjax src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>